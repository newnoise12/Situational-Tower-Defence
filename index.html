<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Mall Manager ‚Äì Phase 3</title>
<style>
body {
  margin:0;
  background:#111;
  color:#eee;
  font-family:Arial;
  display:flex;
}

#game { flex:1; display:block; }

#ui {
  width:320px;
  background:#1b1b1b;
  border-left:1px solid #333;
  padding:12px;
  overflow-y:auto;
}

button {
  width:100%;
  margin-top:6px;
  padding:6px;
}

.stat { margin:4px 0; }
.shopBlock {
  margin-top:12px;
  border-top:1px solid #333;
  padding-top:8px;
}
.small { font-size:12px; color:#aaa; }
</style>
</head>
<body>

<div id="ui">
  <div class="stat">üí∞ Money: <span id="money"></span></div>
  <div class="stat">‚≠ê Reputation: <span id="rep"></span></div>
  <div class="stat">üë• Visitors: <span id="visitors"></span></div>
  <div class="stat">üíº Wave Salary: <span id="salaryDisplay"></span></div>

  <hr>
  <div>Wave: <span id="waveNum">1</span></div>
  <div>Phase: <span id="phaseDisplay">Planning</span></div>
  <button onclick="startWave()">Start Wave</button>

  <hr>
  <b>Wave Overview</b>
  <div id="analyticsPanel" class="small"></div>

  <hr>
  <b>Global Surveillance</b>
  <div id="cctvPanel"></div>
  <button onclick="addGuard()">Place Guard (¬£150)</button>

  <div id="shopControls"></div>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
  canvas.width = window.innerWidth - 320;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

/* ======================
   GAME STATE
====================== */
let money = 600;
let reputation = 50;
let placingGuard = false;

let gamePhase = "planning";
let waveTimer = 0;
let waveLength = 30;
let waveNumber = 1;

let cctvLevel = 0;
const maxLevel = 4;

/* ======================
   WAVE STATS
====================== */
let waveStats = {
  grossSales:0,
  mallIncome:0,
  theftLoss:0,
  theftCount:0,
  offenderSet:new Set(),
  salaryPaid:0
};

const path = [
  {x:200,y:200},
  {x:900,y:200},
  {x:900,y:700},
  {x:200,y:700},
  {x:200,y:200}
];

/* ======================
   SHOPS
====================== */
const shops = [
  {name:"Electronics", x:550,y:200,value:70,baseOpportunity:25,protection:0,management:0,salary:0},
  {name:"Clothing", x:900,y:450,value:40,baseOpportunity:20,protection:0,management:0,salary:0},
  {name:"Jewellery", x:550,y:700,value:100,baseOpportunity:35,protection:0,management:0,salary:0},
  {name:"Food Court", x:200,y:450,value:20,baseOpportunity:10,protection:0,management:0,salary:0}
];

const guards = [];
let visitors = [];

/* ======================
   SALARY HELPERS
====================== */
function getGuardSalaryPerSec(){ return guards.length * 1; }
function getShopSalaryPerSec(){ return shops.reduce((s,x)=>s+(x.salary||0),0); }
function getTotalSalaryPerSec(){ return getGuardSalaryPerSec()+getShopSalaryPerSec(); }

/* ======================
   PHASE CONTROL
====================== */
function startWave(){
  if(gamePhase !== "planning") return;

  waveStats = {
    grossSales:0,
    mallIncome:0,
    theftLoss:0,
    theftCount:0,
    offenderSet:new Set(),
    salaryPaid:0
  };

  gamePhase = "wave";
  waveTimer = waveLength;
}

function endWave(){

  const net = waveStats.mallIncome - waveStats.salaryPaid - waveStats.theftLoss;

  alert(
`Wave ${waveNumber} Results

Revenue
  Sales: ¬£${waveStats.grossSales.toFixed(0)}
  Mall Share: ¬£${waveStats.mallIncome.toFixed(0)}

Crime
  Theft Loss: ¬£${waveStats.theftLoss.toFixed(0)}
  Thefts: ${waveStats.theftCount}
  Offenders: ${waveStats.offenderSet.size}

Costs
  Salary: ¬£${waveStats.salaryPaid.toFixed(0)}

Net Result: ¬£${net.toFixed(0)}`
  );

  gamePhase = "planning";
  waveNumber++;
  document.getElementById("waveNum").innerText = waveNumber;
  visitors = [];
}

/* ======================
   VISITOR SPAWN
====================== */
function spawnVisitor(){
  let type;
  const r = Math.random();

  if(waveNumber===1)
    type = r<0.60?"ordinary":r<0.90?"opportunist":"determined";
  else if(waveNumber===2)
    type = r<0.55?"ordinary":r<0.85?"opportunist":"determined";
  else
    type = r<0.45?"ordinary":r<0.75?"opportunist":"determined";

  const profiles = {
    ordinary:{M:10,S:40,risk:1.5,effort:1.2,maxThefts:1},
    opportunist:{M:25,S:25,risk:1.0,effort:1.0,maxThefts:2},
    determined:{M:40,S:10,risk:0.5,effort:1.5,maxThefts:(waveNumber===1?2:4)}
  };

  const p = profiles[type];

  visitors.push({
    x:200,y:200,
    pathIndex:0,
    speed:60,
    type:type,
    baseS:p.S,
    M:p.M,
    S:p.S,
    O:20,
    R:0,
    riskSensitivity:p.risk,
    effortSensitivity:p.effort,
    theftsCommitted:0,
    maxThefts:p.maxThefts,
    visitedShops:{},
    finished:false
  });
}

/* ======================
   UPDATE
====================== */
function update(dt){
  if(gamePhase==="wave"){

    waveTimer -= dt;

    if(waveTimer > waveLength*0.4){
      if(Math.random()<0.04) spawnVisitor();
    }

    visitors.forEach(v=>{
      moveVisitor(v,dt);
      applySecurity(v);
      checkShops(v);
    });

    const salaryFrame = getTotalSalaryPerSec()*dt;
    waveStats.salaryPaid += salaryFrame;
    money -= salaryFrame;

    visitors = visitors.filter(v=>!v.finished);

    if(waveTimer<=0 && visitors.length===0){
      endWave();
    }
  }
}

function moveVisitor(v,dt){
  if(v.finished) return;

  const target = v.pathIndex+1;
  if(target>=path.length){ v.finished=true; return; }

  const next = path[target];
  const dx=next.x-v.x;
  const dy=next.y-v.y;
  const dist=Math.hypot(dx,dy);
  const step=v.speed*dt;

  if(dist<=step){
    v.x=next.x; v.y=next.y; v.pathIndex++;
  }else{
    v.x+=dx/dist*step;
    v.y+=dy/dist*step;
  }
}

function applySecurity(v){
  v.R = cctvLevel*5;
  v.S = v.baseS;
  guards.forEach(g=>{
    if(Math.hypot(v.x-g.x,v.y-g.y)<g.radius){
      v.R+=15; v.S-=5;
    }
  });
  v.S=Math.max(0,v.S);
}

function checkShops(v){
  shops.forEach((shop,i)=>{
    if(v.visitedShops[i]) return;

    if(Math.hypot(v.x-shop.x,v.y-shop.y)<60){

      v.visitedShops[i]=true;

      v.O = shop.baseOpportunity - shop.protection*5*v.effortSensitivity;
      v.M -= shop.management*2;

      const theftScore = v.M+v.O-(v.R*v.riskSensitivity);

      if(v.theftsCommitted<v.maxThefts && theftScore>30){

        const theftLoss=shop.value*0.75;
        waveStats.theftLoss+=theftLoss;
        waveStats.theftCount++;
        waveStats.offenderSet.add(v);

        money-=theftLoss;
        reputation-=2;
        v.theftsCommitted++;
      }
      else if(v.S>v.M){

        const mallShare=shop.value*0.30;
        waveStats.grossSales+=shop.value;
        waveStats.mallIncome+=mallShare;

        money+=mallShare;
        reputation+=1;
      }
    }
  });
}

/* ======================
   DRAW
====================== */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.strokeStyle="#444";
  ctx.lineWidth=40;
  ctx.beginPath();
  ctx.moveTo(path[0].x,path[0].y);
  for(let i=1;i<path.length;i++)
    ctx.lineTo(path[i].x,path[i].y);
  ctx.stroke();

  visitors.forEach(v=>{
    ctx.fillStyle=v.type==="ordinary"?"#0f0":
                  v.type==="opportunist"?"#ff0":"#f00";
    ctx.beginPath();
    ctx.arc(v.x,v.y,8,0,Math.PI*2);
    ctx.fill();
  });

  document.getElementById("money").innerText=Math.round(money);
  document.getElementById("rep").innerText=Math.round(reputation);
  document.getElementById("visitors").innerText=visitors.length;
  document.getElementById("phaseDisplay").innerText =
    gamePhase==="planning"?"Planning":"Wave Active";

  const totalSalary=(gamePhase==="wave")?getTotalSalaryPerSec():0;
  document.getElementById("salaryDisplay").innerText=
    totalSalary.toFixed(1)+"/sec";

  if(gamePhase==="wave"){
    const net = waveStats.mallIncome - waveStats.salaryPaid - waveStats.theftLoss;

    let netColor="#aaa";
    if(net>0) netColor="#4caf50";
    else if(net<0) netColor="#e53935";
    else netColor="#ffb300";

    document.getElementById("analyticsPanel").innerHTML=`
      üü¢ <b>Revenue</b><br>
      Sales: ¬£${waveStats.grossSales.toFixed(0)}<br>
      Mall Share: ¬£${waveStats.mallIncome.toFixed(0)}<br><br>

      üî¥ <b>Crime</b><br>
      Theft Loss: ¬£${waveStats.theftLoss.toFixed(0)}<br>
      Thefts: ${waveStats.theftCount}<br>
      Offenders: ${waveStats.offenderSet.size}<br><br>

      üîµ <b>Costs</b><br>
      Salary: ¬£${waveStats.salaryPaid.toFixed(0)}<br><br>

      <div style="font-size:16px;color:${netColor}">
        Net: ¬£${net.toFixed(0)}
      </div>
    `;
  }else{
    document.getElementById("analyticsPanel").innerHTML="";
  }
}

let last=0;
function loop(t){
  const dt=(t-last)/1000;
  last=t;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

loop(0);
</script>
</body>
</html>
