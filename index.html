<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Mall Manager ‚Äì Phase 3</title>

<style>
body{
  margin:0;
  background:#111;
  color:#eee;
  font-family:Arial;

  display:flex;
  height:100vh;
  overflow:hidden;   /* prevents scroll + layout break */
}

/* LEFT PANEL */
#ui {
  flex:0 0 280px;
  background:#1b1b1b;
  border-right:1px solid #333;
  padding:12px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

#shopControls {
  overflow-y:auto;
  flex:1;
}

/* CENTER CANVAS */
#game{
  flex:1;
  background:#111;
}

/* RIGHT PANEL */
#analyticsBox{
  flex:0 0 240px;
  background:#1a1a1a;
  border-left:1px solid #333;
  padding:12px;
  overflow-y:auto;
}

#analyticsBox h3{
  margin:0 0 8px 0;
}

button{
  width:100%;
  margin-top:6px;
  padding:6px;
}

.stat{ margin:4px 0; }

.shopBlock{
  margin-top:12px;
  border-top:1px solid #333;
  padding-top:8px;
}

.small{
  font-size:12px;
  color:#aaa;
}
</style>
</head>
<body>

<!-- LEFT PANEL -->
<div id="ui">
  <div class="stat">üí∞ Money: <span id="money"></span></div>
  <div class="stat">‚≠ê Reputation: <span id="rep"></span></div>
  <div class="stat">üë• Visitors: <span id="visitors"></span></div>
  <div class="stat">üíº Wave Salary: <span id="salaryDisplay"></span></div>

  <hr>
  <div>Wave: <span id="waveNum">1</span></div>
  <div>Phase: <span id="phaseDisplay">Planning</span></div>
  <button onclick="startWave()">Start Wave</button>

  <hr>
  <b>Global Surveillance</b>
  <div id="cctvPanel"></div>
  <button onclick="addGuard()">Place Guard (¬£150)</button>
<button onclick="toggleInfo('guards','info_guards')">‚Ñπ</button>
<div id="info_guards"></div>

  <div id="shopControls"></div>
</div>

<!-- CENTER -->
<canvas id="game"></canvas>

<!-- RIGHT PANEL -->
<div id="analyticsBox">
  <h3>Wave Overview</h3>
  <div id="analyticsPanel" class="small"></div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// world size in CSS pixels (what you draw in)
let worldW = 0;
let worldH = 0;

let margin = 0;
let corridorWidth = 0;

let path = [];
const shops = [
  {name:"Electronics", x:0,y:0,value:70,baseOpportunity:25,protection:0,management:0,salary:0},
  {name:"Clothing", x:0,y:0,value:40,baseOpportunity:20,protection:0,management:0,salary:0},
  {name:"Jewellery", x:0,y:0,value:100,baseOpportunity:35,protection:0,management:0,salary:0},
  {name:"Food Court", x:0,y:0,value:20,baseOpportunity:10,protection:0,management:0,salary:0}
];

function updatePath(){
  path = [
    { x: margin,          y: margin },
    { x: worldW - margin, y: margin },
    { x: worldW - margin, y: worldH - margin },
    { x: margin,          y: worldH - margin },
    { x: margin,          y: margin }
  ];
}

function layoutShops(){
  shops[0].x = worldW * 0.50; shops[0].y = margin;           // top middle
  shops[1].x = worldW - margin; shops[1].y = worldH * 0.50;  // right middle
  shops[2].x = worldW * 0.50; shops[2].y = worldH - margin;  // bottom middle
  shops[3].x = margin; shops[3].y = worldH * 0.50;           // left middle
}

function layoutShops(){
  // keep them positioned relative to the current canvas size
  shops[0].x = worldW * 0.50; shops[0].y = margin;          // Electronics (top middle)
  shops[1].x = worldW - margin; shops[1].y = worldH * 0.50; // Clothing (right middle)
  shops[2].x = worldW * 0.50; shops[2].y = worldH - margin; // Jewellery (bottom middle)
  shops[3].x = margin; shops[3].y = worldH * 0.50;          // Food Court (left middle)
}

function resizeCanvas(){

  // Get the actual on-screen size of the canvas
  console.log("worldW:", worldW, "worldH:", worldH);
  console.log("Canvas width:", rect.width);
  canvas.style.background = "rgba(255,0,0,0.1)";

  const rect = canvas.getBoundingClientRect();

  worldW = rect.width;
  worldH = rect.height;

  // Handle high-DPI screens properly
  const dpr = window.devicePixelRatio || 1;

  canvas.width  = Math.round(worldW * dpr);
  canvas.height = Math.round(worldH * dpr);

  // Tell canvas to draw using CSS pixel coordinates
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  // üîµ VERY IMPORTANT:
  // Keep margins proportional but safe
  margin = Math.min(worldW, worldH) * 0.10;
  corridorWidth = Math.min(worldW, worldH) * 0.05;

  updatePath();
  layoutShops();
}

/* ======================
   GAME STATE
====================== */
let money = 600;
let reputation = 50;
let placingGuard = false;

let gamePhase = "planning";
let waveTimer = 0;
let waveLength = 30;
let waveNumber = 1;

let cctvLevel = 0;
const maxLevel = 4;

/* ======================
   WAVE STATS (ANALYTICS)
====================== */
let waveStats = {
  grossSales: 0,
  mallIncome: 0,
  theftLoss: 0,
  theftCount: 0,
  offenderSet: new Set(),
  salaryPaid: 0
};

/* ======================
   UPGRADE DATA
====================== */
const managementLevels = [
  "Basic Layout",
  "Clear Anti-Theft Signage",
  "Improved Lighting",
  "Staff Training",
  "Active Customer Engagement"
];

const cctvLevels = [
  "No CCTV",
  "Visible Cameras",
  "Monitored Cameras",
  "AI Detection System",
  "Integrated Security Network"
];

const protectionLevels = {
  Electronics:[
    "Open Display Tables",
    "Security Tags",
    "Locked Cabinets",
    "Staff-Assisted Sales",
    "Smart Anti-Theft System"
  ],
  Jewellery:[
    "Open Counter",
    "Glass Display Case",
    "Locked Case",
    "Staff-Controlled Viewing",
    "Secure Vault Storage"
  ],
  Clothing:[
    "Open Racks",
    "Security Tags",
    "Fitting Room Monitoring",
    "Item Check System",
    "Controlled Entry System"
  ],
  "Food Court":[
    "Open Counter Service",
    "Staff Supervision",
    "Queue Management",
    "Controlled Payment Area",
    "Cashless Payment Only"
  ]
};

/* ======================
   SHOPS
====================== */


const guards = [];
let visitors = [];

/* ======================
   COST CALC
====================== */
function upgradeCost(base, level){
  return base * (level + 1);
}

/* ======================
   SALARY HELPERS
====================== */
function getGuardSalaryPerSec(){
  return guards.length * 1; // unchanged
}
function getShopSalaryPerSec(){
  return shops.reduce((sum, s) => sum + (s.salary || 0), 0);
}
function getTotalSalaryPerSec(){
  return getGuardSalaryPerSec() + getShopSalaryPerSec();
}

/* ======================
   UI BUILDERS
====================== */
  function toggleInfo(key, elementId){

  const container = document.getElementById(elementId);

  // If already open, close it
  if(container.innerHTML !== ""){
    container.innerHTML = "";
    return;
  }

  container.innerHTML = `
    <div style="
      background:#222;
      padding:8px;
      margin-top:6px;
      border:1px solid #333;
      font-size:12px;
    ">
      ${infoText[key]}
    </div>
  `;
}
function buildShopUI(){
  const container = document.getElementById("shopControls");
  container.innerHTML = "";

  shops.forEach((shop,i)=>{

    const protectionText = protectionLevels[shop.name][shop.protection];
    const managementText = managementLevels[shop.management];

    const protectionCost = shop.protection < maxLevel ?
      upgradeCost(100, shop.protection) : null;

    const managementCost = shop.management < maxLevel ?
      upgradeCost(80, shop.management) : null;

    const div = document.createElement("div");
    div.className="shopBlock";

    div.innerHTML = `
      <b>${shop.name}</b>

      <div class="small">
        Product Protection: Level ${shop.protection}<br>
        ${protectionText}
      </div>

      ${
        shop.protection < maxLevel
        ? `
          <button onclick="upgradeProtection(${i})">
            Upgrade Protection (¬£${protectionCost})
          </button>
          <button onclick="toggleInfo('protection','info_p_${i}')">‚Ñπ</button>
          <div id="info_p_${i}"></div>
        `
        : "<div class='small'>Max Level</div>"
      }

      <div class="small">
        Store Management: Level ${shop.management}<br>
        ${managementText}
      </div>

      ${
        shop.management < maxLevel
        ? `
          <button onclick="upgradeManagement(${i})">
            Upgrade Management (¬£${managementCost})
          </button>
          <button onclick="toggleInfo('management','info_m_${i}')">‚Ñπ</button>
          <div id="info_m_${i}"></div>
        `
        : "<div class='small'>Max Level</div>"
      }

      <div class="small">
        Staff Cost During Wave: ¬£${(shop.salary || 0).toFixed(1)} / sec
      </div>
    `;

    container.appendChild(div);
  });
}

function buildCCTVUI(){
  const panel = document.getElementById("cctvPanel");
  const text = cctvLevels[cctvLevel];
  const cost = cctvLevel < maxLevel ?
    upgradeCost(120, cctvLevel) : null;

  panel.innerHTML = `
    <div class="small">
      CCTV Level ${cctvLevel}<br>
      ${text}
    </div>

    ${
      cctvLevel < maxLevel
      ? `
        <button onclick="upgradeCCTV()">Upgrade CCTV (¬£${cost})</button>
        <button onclick="toggleInfo('cctv','info_cctv')">‚Ñπ</button>
        <div id="info_cctv"></div>
      `
      : "<div class='small'>Max Level</div>"
    }
  `;
}

/* ======================
   UPGRADES
====================== */
function upgradeProtection(i){
  if(gamePhase !== "planning") return;
  const shop = shops[i];
  if(shop.protection >= maxLevel) return;

  const cost = upgradeCost(100, shop.protection);
  if(money < cost) return;

  money -= cost;
  shop.protection++;

  // Staff-based protection levels
  if(shop.protection === 3) shop.salary += 0.5;
  if(shop.protection === 4) shop.salary += 0.8;

  buildShopUI();
}

function upgradeManagement(i){
  if(gamePhase !== "planning") return;
  const shop = shops[i];
  if(shop.management >= maxLevel) return;

  const cost = upgradeCost(80, shop.management);
  if(money < cost) return;

  money -= cost;
  shop.management++;

  // Staff-heavy management levels
  if(shop.management === 3) shop.salary += 0.4;
  if(shop.management === 4) shop.salary += 0.6;

  buildShopUI();
}

function upgradeCCTV(){
  if(gamePhase !== "planning") return;
  if(cctvLevel >= maxLevel) return;

  const cost = upgradeCost(120, cctvLevel);
  if(money < cost) return;

  money -= cost;
  cctvLevel++;
  buildCCTVUI();
}
/* ======================
   INFO SYSTEM TEXT
====================== */

const infoText = {
  protection: `
  <b>Product Protection</b><br>
  Reduces <b>Opportunity</b>.<br><br>
  ‚Ä¢ Makes items harder to steal<br>
  ‚Ä¢ Strong against opportunists<br>
  ‚Ä¢ Less effective against highly determined offenders<br><br>
  Works by increasing effort required.
  `,

  management: `
  <b>Store Management</b><br>
  Reduces <b>Motivation</b>.<br><br>
  ‚Ä¢ Increases social awareness<br>
  ‚Ä¢ Staff presence discourages theft<br>
  ‚Ä¢ Builds informal guardianship<br><br>
  Works by reducing temptation.
  `,

  cctv: `
  <b>Surveillance (CCTV)</b><br>
  Increases <b>Perceived Risk</b>.<br><br>
  ‚Ä¢ Offenders feel more likely to be caught<br>
  ‚Ä¢ Strong against risk-sensitive individuals<br>
  ‚Ä¢ Weaker against highly motivated offenders<br><br>
  Works by increasing perceived detection.
  `,

  guards: `
  <b>Security Guards</b><br>
  Strongly increases <b>Local Risk</b>.<br><br>
  ‚Ä¢ Powerful deterrent within area<br>
  ‚Ä¢ Reduces repeat offending<br>
  ‚Ä¢ Expensive to maintain<br><br>
  Works through visible authority presence.
  `
};

/* ======================
   PHASE CONTROL
====================== */
function startWave(){
  if(gamePhase !== "planning") return;

  // reset wave analytics
  waveStats = {
    grossSales: 0,
    mallIncome: 0,
    theftLoss: 0,
    theftCount: 0,
    offenderSet: new Set(),
    salaryPaid: 0
  };

  gamePhase = "wave";
  waveTimer = waveLength;
}

function endWave(){
  const net = waveStats.mallIncome - waveStats.salaryPaid - waveStats.theftLoss;

  alert(
`Wave ${waveNumber} Results

Revenue
  Sales: ¬£${waveStats.grossSales.toFixed(0)}
  Mall Share: ¬£${waveStats.mallIncome.toFixed(0)}

Crime
  Theft Loss: ¬£${waveStats.theftLoss.toFixed(0)}
  Thefts: ${waveStats.theftCount}
  Offenders: ${waveStats.offenderSet.size}

Costs
  Salary: ¬£${waveStats.salaryPaid.toFixed(0)}

Net Result: ¬£${net.toFixed(0)}`
  );

  gamePhase = "planning";
  waveNumber++;
  document.getElementById("waveNum").innerText = waveNumber;
  visitors = [];
}

/* ======================
   GUARDS
====================== */
canvas.addEventListener("click", function(e){
  if(!placingGuard || gamePhase !== "planning") return;

  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  guards.push({ x, y, radius:130 });

  money -= 150;
  placingGuard = false;
});

function addGuard(){
  if(gamePhase !== "planning") return;
  if(money < 150) return;
  placingGuard = true;
}

/* ======================
   VISITOR LOGIC
====================== */
function spawnVisitor(){
  let type;
  const r = Math.random();

  if(waveNumber === 1){
    type = r < 0.60 ? "ordinary" : r < 0.90 ? "opportunist" : "determined";
  } else if(waveNumber === 2){
    type = r < 0.55 ? "ordinary" : r < 0.85 ? "opportunist" : "determined";
  } else {
    type = r < 0.45 ? "ordinary" : r < 0.75 ? "opportunist" : "determined";
  }

  const profiles = {
    ordinary:{ M:10, S:40, risk:1.5, effort:1.2, maxThefts:1 },
    opportunist:{ M:25, S:25, risk:1.0, effort:1.0, maxThefts:2 },
    determined:{ M:40, S:10, risk:0.5, effort:1.5, maxThefts: (waveNumber === 1 ? 2 : 4) }
  };

  const p = profiles[type];

  visitors.push({
    x: path[0].x,
    y: path[0].y,

    pathIndex:0,
    speed:60,
    type:type,

    baseS:p.S,
    M:p.M,
    S:p.S,
    O:20,
    R:0,

    riskSensitivity:p.risk,
    effortSensitivity:p.effort,

    theftsCommitted:0,
    maxThefts:p.maxThefts,

    visitedShops:{},
    finished:false
  });
}

/* ======================
   UPDATE
====================== */
function update(dt){
  if(gamePhase === "wave"){
    waveTimer -= dt;

    // spawn only during first 60% of wave
    if(waveTimer > waveLength * 0.4){
      if(Math.random() < 0.04) spawnVisitor();
    }

    visitors.forEach(v=>{
      moveVisitor(v,dt);
      applySecurity(v);
      checkShops(v);
    });

    // salary tracking + payment (wave only)
    const salaryFrame = getTotalSalaryPerSec() * dt;
    waveStats.salaryPaid += salaryFrame;
    money -= salaryFrame;

    // remove finished visitors
    visitors = visitors.filter(v => !v.finished);

    // end wave only when timer ended AND no visitors remain
    if(waveTimer <= 0 && visitors.length === 0){
      endWave();
    }
  }
}

function moveVisitor(v, dt){
  if(v.finished) return;

  const targetIndex = v.pathIndex + 1;
  if(targetIndex >= path.length){
    v.finished = true;
    return;
  }

  const next = path[targetIndex];
  const dx = next.x - v.x;
  const dy = next.y - v.y;
  const dist = Math.hypot(dx, dy);
  const step = v.speed * dt;

  if(dist <= step){
    v.x = next.x;
    v.y = next.y;
    v.pathIndex++;
  } else {
    v.x += dx / dist * step;
    v.y += dy / dist * step;
  }
}

function applySecurity(v){
  v.R = cctvLevel * 5;
  v.S = v.baseS;

  guards.forEach(g=>{
    if(Math.hypot(v.x-g.x,v.y-g.y) < g.radius){
      v.R += 15;
      v.S -= 5;
    }
  });

  v.S = Math.max(0, v.S);
}

function checkShops(v){
  shops.forEach((shop, index)=>{
    if(v.visitedShops[index]) return;

    if(Math.hypot(v.x-shop.x, v.y-shop.y) < 60){
      v.visitedShops[index] = true;

      v.O = shop.baseOpportunity - shop.protection * 5 * v.effortSensitivity;
      v.M -= shop.management * 2;

      const theftScore = v.M + v.O - (v.R * v.riskSensitivity);

      if(v.theftsCommitted < v.maxThefts && theftScore > 30){
        const theftLoss = shop.value * 0.75;

        waveStats.theftLoss += theftLoss;
        waveStats.theftCount++;
        waveStats.offenderSet.add(v);

        money -= theftLoss;
        reputation -= 2;
        v.theftsCommitted++;

        // If you re-enable emboldening later, do it carefully:
        // if(v.type === "determined"){ v.M = Math.min(v.M + 3, 45); }

      } else if(v.S > v.M){
        const mallShare = shop.value * 0.30;

        waveStats.grossSales += shop.value;
        waveStats.mallIncome += mallShare;

        money += mallShare;
        reputation += 1;
      }
    }
  });
}

/* ======================
   DRAW
====================== */
function draw(){
 ctx.save();
ctx.setTransform(1, 0, 0, 1, 0, 0);
ctx.clearRect(0, 0, canvas.width, canvas.height);
ctx.restore();

  // path
ctx.strokeStyle = "#444";
ctx.lineWidth = corridorWidth;
ctx.lineJoin = "round";
ctx.lineCap = "round";

ctx.beginPath();
ctx.moveTo(path[0].x, path[0].y);
for(let i = 1; i < path.length; i++){
  ctx.lineTo(path[i].x, path[i].y);
}
ctx.stroke();

  // shops
  shops.forEach(shop=>{
    ctx.fillStyle="#333";
    ctx.fillRect(shop.x-50,shop.y-30,100,60);
    ctx.fillStyle="#fff";
    ctx.fillText(shop.name,shop.x-40,shop.y);
  });

  // guards
  guards.forEach(g=>{
    ctx.strokeStyle="rgba(0,200,255,0.3)";
    ctx.beginPath();
    ctx.arc(g.x,g.y,g.radius,0,Math.PI*2);
    ctx.stroke();

    ctx.fillStyle="#0ff";
    ctx.fillRect(g.x-6,g.y-6,12,12);
  });

  // visitors
  visitors.forEach(v=>{
    ctx.fillStyle=v.type==="ordinary"?"#0f0"
               : v.type==="opportunist"?"#ff0":"#f00";
    ctx.beginPath();
    ctx.arc(v.x,v.y,8,0,Math.PI*2);
    ctx.fill();
  });

  // top stats
  document.getElementById("money").innerText = Math.round(money);
  document.getElementById("rep").innerText = Math.round(reputation);
  document.getElementById("visitors").innerText = visitors.length;
  document.getElementById("phaseDisplay").innerText =
    gamePhase === "planning" ? "Planning" : "Wave Active";

  const totalSalary = (gamePhase === "wave") ? getTotalSalaryPerSec() : 0;
  document.getElementById("salaryDisplay").innerText =
    totalSalary.toFixed(1) + "/sec";

  // analytics panel (right)
  if(gamePhase === "wave"){
    const net = waveStats.mallIncome - waveStats.salaryPaid - waveStats.theftLoss;

    let netColor = "#aaa";
    if(net > 0) netColor = "#4caf50";
    else if(net < 0) netColor = "#e53935";
    else netColor = "#ffb300";

    document.getElementById("analyticsPanel").innerHTML = `
      üü¢ <b>Revenue</b><br>
      Sales: ¬£${waveStats.grossSales.toFixed(0)}<br>
      Mall Share: ¬£${waveStats.mallIncome.toFixed(0)}<br><br>

      üî¥ <b>Crime</b><br>
      Theft Loss: ¬£${waveStats.theftLoss.toFixed(0)}<br>
      Thefts: ${waveStats.theftCount}<br>
      Offenders: ${waveStats.offenderSet.size}<br><br>

      üîµ <b>Costs</b><br>
      Salary: ¬£${waveStats.salaryPaid.toFixed(0)}<br><br>

      <div style="font-size:16px; color:${netColor}">
        Net: ¬£${net.toFixed(0)}
      </div>
    `;
  } else {
    document.getElementById("analyticsPanel").innerHTML = "<span class='small'>Start a wave to see live results.</span>";
  }
}

/* ======================
   GAME LOOP
====================== */
let last=0;
function loop(t){
  const dt=(t-last)/1000;
  last=t;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

// Build UI and start
buildShopUI();
buildCCTVUI();
loop(0);
</script>

</body>
</html>

















