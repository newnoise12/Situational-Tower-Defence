<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Mall Manager ‚Äì SCP Simulation</title>
<style>
body { margin:0; background:#111; color:#eee; font-family:Arial; }
#ui {
  position:absolute; left:10px; top:10px;
  background:#1b1b1b; padding:12px;
  border-radius:10px; border:1px solid #333;
  width:260px;
}
button { width:100%; margin-top:6px; padding:6px; }
canvas { display:block; }
.stat { margin:4px 0; }
</style>
</head>
<body>

<div id="ui">
  <div class="stat">üí∞ Money: <span id="money"></span></div>
  <div class="stat">‚≠ê Reputation: <span id="rep"></span></div>
  <div class="stat">üë• Visitors: <span id="visitors"></span></div>

  <hr>

  <b>Upgrade Electronics Shop</b>
  <button onclick="upgradeShop(0,'hardening')">+ Hardening</button>
  <button onclick="upgradeShop(0,'signage')">+ Signage</button>
  <button onclick="upgradeShop(0,'environment')">+ Environment</button>

  <hr>
  <button onclick="addGuard()">Add Guard (¬£150)</button>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let money = 500;
let reputation = 50;

const path = [
  {x:200,y:200},{x:800,y:200},
  {x:800,y:600},{x:200,y:600}
];

const shops = [
  {name:"Electronics", x:500, y:200, width:120, height:60,
   value:50, hardening:0, signage:0, environment:0}
];

const guards = [];
const visitors = [];

function spawnVisitor() {
  const typeRoll = Math.random();
  let type;
  if (reputation > 70) {
    type = typeRoll < 0.7 ? "ordinary" :
           typeRoll < 0.95 ? "opportunist" : "determined";
  } else if (reputation < 30) {
    type = typeRoll < 0.3 ? "ordinary" :
           typeRoll < 0.7 ? "opportunist" : "determined";
  } else {
    type = typeRoll < 0.5 ? "ordinary" :
           typeRoll < 0.85 ? "opportunist" : "determined";
  }

  const profiles = {
    ordinary:{M:10,S:40,risk:1.5,effort:1.2,excuse:1.5},
    opportunist:{M:25,S:25,risk:1.0,effort:1.0,excuse:1.0},
    determined:{M:40,S:10,risk:0.5,effort:1.5,excuse:0.5}
  };

  const p = profiles[type];

  visitors.push({
    x:200,y:200,
    pathIndex:0,
    progress:0,
    speed:60,
    type:type,
    M:p.M,
    S:p.S,
    O:20,
    R:0,
    riskSensitivity:p.risk,
    effortSensitivity:p.effort,
    excuseSensitivity:p.excuse,
    attempted:false
  });
}

function upgradeShop(index,type){
  const shop = shops[index];
  const cost = 100;
  if(money < cost) return;
  money -= cost;
  shop[type]++;
}

function addGuard(){
  if(money < 150) return;
  money -= 150;
  guards.push({x:500,y:400, radius:150});
}

function update(dt){
  if(Math.random()<0.02) spawnVisitor();

  visitors.forEach(v=>{
    moveVisitor(v,dt);
    applySecurity(v);
    checkShopInteraction(v);
  });

  for(let i=visitors.length-1;i>=0;i--){
    if(visitors[i].pathIndex>=path.length){
      visitors.splice(i,1);
    }
  }
}

function moveVisitor(v,dt){
  const next = path[(v.pathIndex+1)%path.length];
  const dx = next.x - v.x;
  const dy = next.y - v.y;
  const dist = Math.hypot(dx,dy);

  if(dist < 2){
    v.pathIndex++;
  } else {
    v.x += dx/dist * v.speed * dt;
    v.y += dy/dist * v.speed * dt;
  }
}

function applySecurity(v){
  v.R = 0;
  guards.forEach(g=>{
    const d = Math.hypot(v.x-g.x,v.y-g.y);
    if(d<g.radius){
      v.R += 15;
    }
  });
}

function checkShopInteraction(v){
  if(v.attempted) return;

  shops.forEach(shop=>{
    if(v.x>shop.x-shop.width/2 &&
       v.x<shop.x+shop.width/2 &&
       v.y>shop.y-shop.height/2 &&
       v.y<shop.y+shop.height/2){

      v.O -= shop.hardening * 5 * v.effortSensitivity;
      v.M -= shop.environment * 1;
      v.M -= shop.signage * 3 * v.excuseSensitivity;

      const theftScore = v.M + v.O - (v.R * v.riskSensitivity);

      if(theftScore > 30){
        money -= shop.value;
        reputation -= 5;
      } else if(v.S > v.M){
        money += shop.value;
        reputation += 1;
      }

      v.attempted = true;
    }
  });
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Path
  ctx.strokeStyle="#444";
  ctx.lineWidth=40;
  ctx.beginPath();
  ctx.moveTo(path[0].x,path[0].y);
  path.forEach(p=>ctx.lineTo(p.x,p.y));
  ctx.closePath();
  ctx.stroke();

  // Shops
  shops.forEach(shop=>{
    ctx.fillStyle="#333";
    ctx.fillRect(shop.x-shop.width/2,shop.y-shop.height/2,shop.width,shop.height);
    ctx.fillStyle="#fff";
    ctx.fillText(shop.name,shop.x-40,shop.y);
  });

  // Guards
  guards.forEach(g=>{
    ctx.strokeStyle="rgba(0,200,255,0.4)";
    ctx.beginPath();
    ctx.arc(g.x,g.y,g.radius,0,Math.PI*2);
    ctx.stroke();
    ctx.fillStyle="#0ff";
    ctx.fillRect(g.x-5,g.y-5,10,10);
  });

  // Visitors
  visitors.forEach(v=>{
    ctx.fillStyle = v.type==="ordinary"?"#0f0":
                    v.type==="opportunist"?"#ff0":"#f00";
    ctx.beginPath();
    ctx.arc(v.x,v.y,8,0,Math.PI*2);
    ctx.fill();

    drawBar(v.x-15,v.y-20,v.M,50,"red");
    drawBar(v.x-15,v.y-14,v.R,50,"purple");
  });

  document.getElementById("money").innerText = money;
  document.getElementById("rep").innerText = reputation;
  document.getElementById("visitors").innerText = visitors.length;
}

function drawBar(x,y,value,max,color){
  ctx.fillStyle="#000";
  ctx.fillRect(x,y,30,4);
  ctx.fillStyle=color;
  ctx.fillRect(x,y,(value/max)*30,4);
}

let last=0;
function loop(timestamp){
  const dt=(timestamp-last)/1000;
  last=timestamp;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}
loop(0);
</script>
</body>
</html>
