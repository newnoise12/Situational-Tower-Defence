<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Mall Manager ‚Äì Phase 3</title>
<style>
body {
  margin:0;
  background:#111;
  color:#eee;
  font-family:Arial;
  display:flex;
  height:100vh;
  overflow:hidden;
}

/* LEFT PANEL */
#ui {
  width:320px;
  background:#1b1b1b;
  border-right:1px solid #333;
  padding:12px;
  overflow-y:auto;
}

/* CENTER CANVAS */
#game {
  flex:1;
  display:block;
}

/* RIGHT PANEL */
#analyticsBox {
  width:260px;
  background:#1a1a1a;
  border-left:1px solid #333;
  padding:12px;
  overflow-y:auto;
}

#analyticsBox h3{
  margin:0 0 8px 0;
}

.rightTabs{
  display:flex;
  gap:8px;
  margin-bottom:10px;
}
.rightTabs button{
  flex:1;
  padding:8px;
  margin:0;
}

button {
  width:100%;
  margin-top:6px;
  padding:6px;
}

.stat { margin:4px 0; }

.shopBlock {
  margin-top:12px;
  border-top:1px solid #333;
  padding-top:8px;
}

.small { font-size:12px; color:#aaa; }

.row {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
}

.infoBtn{
  width:auto;
  padding:2px 8px;
  margin:0;
  font-size:12px;
  cursor:pointer;
  background:#2a2a2a;
  border:1px solid #444;
  color:#ddd;
  border-radius:6px;
}
.infoBtn:hover{
  background:#333;
}

/* Floating tooltip */
#tooltip{
  position:fixed;
  pointer-events:none;
  background:rgba(20,20,20,0.96);
  border:1px solid #444;
  padding:8px 10px;
  border-radius:10px;
  font-size:12px;
  color:#eee;
  max-width:260px;
  line-height:1.3;
  display:none;
  z-index:9999;
  box-shadow:0 8px 22px rgba(0,0,0,0.35);
}
#tooltip .muted{ color:#aaa; font-size:11px; }

</style>
</head>
<body>

<!-- LEFT PANEL -->
<div id="ui">

  <div class="stat">üí∞ Money: <span id="money"></span></div>
  <div class="stat">‚≠ê Reputation: <span id="rep"></span></div>
  <div class="stat">üë• Visitors: <span id="visitors"></span></div>
  <div class="stat">üíº Wave Salary: <span id="salaryDisplay"></span></div>

  <hr>

  <div>Wave: <span id="waveNum">1</span></div>
  <div>Phase: <span id="phaseDisplay">Planning</span></div>
  <button onclick="startWave()">Start Wave</button>

  <hr>

  <div class="row">
    <b>Global Surveillance</b>
    <button class="infoBtn"
      onmouseenter="showTooltip(event,'cctv')"
      onmousemove="moveTooltip(event)"
      onmouseleave="hideTooltip()"
      onclick="showInfoPanel('cctv')"
      title="More info"
    >‚Ñπ</button>
  </div>

  <div id="cctvPanel"></div>

  <div class="row" style="margin-top:10px;">
    <button onclick="addGuard()">Place Guard (¬£150)</button>
    <button class="infoBtn"
      onmouseenter="showTooltip(event,'guards')"
      onmousemove="moveTooltip(event)"
      onmouseleave="hideTooltip()"
      onclick="showInfoPanel('guards')"
      title="More info"
    >‚Ñπ</button>
  </div>

  <div id="shopControls"></div>

</div>

<!-- CENTER CANVAS -->
<canvas id="game"></canvas>

<!-- RIGHT PANEL -->
<div id="analyticsBox">
  <h3 id="rightTitle">Wave Overview</h3>

  <div class="rightTabs">
    <button onclick="setRightMode('wave')">Wave Overview</button>
    <button onclick="setRightMode('info')">Security Info</button>
  </div>

  <div id="analyticsPanel" class="small">Start a wave to see results.</div>
  <div id="infoPanel" class="small" style="display:none;">
    Click any ‚Ñπ button to see details here.
  </div>
</div>

<!-- floating tooltip -->
<div id="tooltip"></div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
  canvas.width = window.innerWidth - 320 - 260;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

/* ======================
   GAME STATE
====================== */
let money = 600;
let reputation = 50;
let placingGuard = false;
let selectedShopIndex = null;
let hoveredShopIndex = null;


let gamePhase = "planning";
let waveTimer = 0;
let waveLength = 30;
let waveNumber = 1;

let cctvLevel = 0;
const maxLevel = 4;

const path = [
  {x:200,y:200},  // Entrance
  {x:900,y:200},
  {x:900,y:700},
  {x:200,y:700},
  {x:200,y:200}   // Exit (back to entrance)
];

// üîπ Wave analytics (persistent reference)
let waveStats = {
  mallRevenue: 0,
  theftLoss: 0,
  thefts: 0,
  offenders: new Set(),
  salaryPaid: 0,

  // NEW: experiment visibility
  visitorTypes: { ordinary: 0, opportunist: 0, determined: 0 },
  theftsByType:  { ordinary: 0, opportunist: 0, determined: 0 }


};

/* ======================
   INFO TEXT (SECURITY HELP)
====================== */
const infoText = {
  cctv: `
    <b>Surveillance (CCTV)</b><br>
    Increases <b>perceived risk</b> (R).<br><br>
    <span class="muted">
    ‚Ä¢ Works best on risk-sensitive visitors<br>
    ‚Ä¢ Helps across the whole mall<br>
    ‚Ä¢ Less effective against highly motivated offenders
    </span>
  `,
  guards: `
    <b>Security Guards</b><br>
    Strong local deterrent (big R boost in range).<br><br>
    <span class="muted">
    ‚Ä¢ Powerful near the guard radius<br>
    ‚Ä¢ Helps reduce repeat offending pressure<br>
    ‚Ä¢ Costs money every second during a wave
    </span>
  `,
  protection: `
    <b>Product Protection</b><br>
    Reduces <b>opportunity</b> (O) for theft in a store.<br><br>
    <span class="muted">
    ‚Ä¢ Makes items harder to steal<br>
    ‚Ä¢ Strong vs opportunists<br>
    ‚Ä¢ Determined offenders may still try
    </span>
  `,
  management: `
    <b>Store Management</b><br>
    Reduces <b>motivation</b> (M) by improving staff presence/awareness.<br><br>
    <span class="muted">
    ‚Ä¢ Discourages casual theft<br>
    ‚Ä¢ Builds informal guardianship<br>
    ‚Ä¢ Higher levels can increase staffing cost
    </span>
  `
};

/* ======================
   RIGHT PANEL MODES
====================== */
let rightMode = "wave";

function setRightMode(mode){
  rightMode = mode;

  const analytics = document.getElementById("analyticsPanel");
  const info = document.getElementById("infoPanel");
  const title = document.getElementById("rightTitle");

  if(mode === "wave"){
    title.innerText = "Wave Overview";
    analytics.style.display = "block";
    info.style.display = "none";
  } else {
    title.innerText = "Security Info";
    analytics.style.display = "none";
    info.style.display = "block";
  }
}

function showInfoPanel(key, shopName){
  setRightMode("info");
  const panel = document.getElementById("infoPanel");

  // Optional: show which shop it's about
  const prefix = shopName ? `<div style="margin-bottom:6px;"><b>${shopName}</b></div>` : "";

  panel.innerHTML = `
    ${prefix}
    ${infoText[key] || "No info available."}
    <div class="muted" style="margin-top:8px;">
      Tip: Hover ‚Ñπ for a quick tooltip, click ‚Ñπ to pin the info here.
    </div>
  `;
}

/* ======================
   TOOLTIP
====================== */
const tooltip = document.getElementById("tooltip");

function showTooltip(e, key){
  tooltip.innerHTML = infoText[key] || "";
  tooltip.style.display = "block";
  moveTooltip(e);
}
function moveTooltip(e){
  const pad = 14;
  let x = e.clientX + pad;
  let y = e.clientY + pad;

  // keep on-screen
  const rect = tooltip.getBoundingClientRect();
  if(x + rect.width > window.innerWidth) x = e.clientX - rect.width - pad;
  if(y + rect.height > window.innerHeight) y = e.clientY - rect.height - pad;

  tooltip.style.left = x + "px";
  tooltip.style.top = y + "px";
}
function hideTooltip(){
  tooltip.style.display = "none";
}

/* ======================
   UPGRADE DATA
====================== */
const managementLevels = [
  "Basic Layout",
  "Clear Anti-Theft Signage",
  "Improved Lighting",
  "Staff Training",
  "Active Customer Engagement"
];

const cctvLevels = [
  "No CCTV",
  "Visible Cameras",
  "Monitored Cameras",
  "AI Detection System",
  "Integrated Security Network"
];

const protectionLevels = {
  Electronics:[
    "Open Display Tables",
    "Security Tags",
    "Locked Cabinets",
    "Staff-Assisted Sales",
    "Smart Anti-Theft System"
  ],
  Jewellery:[
    "Open Counter",
    "Glass Display Case",
    "Locked Case",
    "Staff-Controlled Viewing",
    "Secure Vault Storage"
  ],
  Clothing:[
    "Open Racks",
    "Security Tags",
    "Fitting Room Monitoring",
    "Item Check System",
    "Controlled Entry System"
  ],
  "Food Court":[
    "Open Counter Service",
    "Staff Supervision",
    "Queue Management",
    "Controlled Payment Area",
    "Cashless Payment Only"
  ]
};
/* ======================
   MALL NODE GRAPH
====================== */

const nodes = {
  entranceMain: { 
    id:"entranceMain", 
    x:120, 
    y:450, 
    type:"transit", 
    connections:["hub"] 
  },

  entranceSide: { 
    id:"entranceSide", 
    x:1120, 
    y:450, 
    type:"transit", 
    connections:["hub"] 
  },

  hub: {
    id:"hub",
    x:600,
    y:450,
    type:"decision",
    connections:["entranceMain","entranceSide","north","east","south","west"]
  },

  north: { id:"north", x:600, y:150, type:"shop", connections:["hub"] },
  east:  { id:"east",  x:1000,y:450, type:"shop", connections:["hub"] },
  south: { id:"south", x:600, y:750, type:"shop", connections:["hub"] },
  west:  { id:"west",  x:200, y:750, type:"shop", connections:["hub"] }
};

/* ======================
   SHOPS
====================== */
const shops = [
  {name:"Electronics", node:"north", value:70,  baseOpportunity:25, protection:0, management:0, salary:0, rep:50, theftCount:0},
  {name:"Clothing",    node:"east",  value:40,  baseOpportunity:20, protection:0, management:0, salary:0, rep:50, theftCount:0},
  {name:"Jewellery",   node:"south", value:100, baseOpportunity:35, protection:0, management:0, salary:0, rep:50, theftCount:0},
  {name:"Food Court",  node:"hub",   value:20,  baseOpportunity:10, protection:0, management:0, salary:0, rep:50, theftCount:0}
];

const guards = [];
let visitors = [];

/* ======================
   COST CALC
====================== */
function upgradeCost(base, level){
  return base * (level + 1);
}

/* ======================
   SALARY HELPERS
====================== */
function getGuardSalaryPerSec(){
  return guards.length * 1;
}

function getShopSalaryPerSec(){
  return shops.reduce((sum, s) => sum + (s.salary || 0), 0);
}

function getTotalSalaryPerSec(){
  return getGuardSalaryPerSec() + getShopSalaryPerSec();
}

/* ======================
   UI BUILDERS
====================== */
function buildSelectedShopUI(){

  const container = document.getElementById("shopControls");
  container.innerHTML = "";

  if(selectedShopIndex === null){
    container.innerHTML = "<div class='small'>Click a shop to manage it.</div>";
    return;
  }

  const shop = shops[selectedShopIndex];

  container.innerHTML = `
    <h4>${shop.name}</h4>
    <div class="small">
      Reputation: ${Math.round(shop.rep)}
    </div>

    <hr>

    <div class="small">
      Protection Level: ${shop.protection}
    </div>
    <button onclick="upgradeProtection(${selectedShopIndex})">
      Upgrade Protection
    </button>

    <div class="small" style="margin-top:8px;">
      Management Level: ${shop.management}
    </div>
    <button onclick="upgradeManagement(${selectedShopIndex})">
      Upgrade Management
    </button>

    <div class="small" style="margin-top:8px;">
      Staff Cost: ¬£${shop.salary.toFixed(1)} / sec
    </div>
  `;
}

function buildCCTVUI(){
  const panel = document.getElementById("cctvPanel");
  const text = cctvLevels[cctvLevel];
  const cost = cctvLevel < maxLevel ?
    upgradeCost(120, cctvLevel) : null;

  panel.innerHTML = `
    <div class="small">
      CCTV Level ${cctvLevel}<br>
      ${text}
    </div>
    ${cctvLevel < maxLevel ?
      `<button onclick="upgradeCCTV()">Upgrade CCTV (¬£${cost})</button>`
      : "<div class='small'>Max Level</div>"}
  `;
}

/* ======================
   UPGRADES
====================== */
function upgradeProtection(i){
  if(gamePhase !== "planning") return;
  const shop = shops[i];
  if(shop.protection >= maxLevel) return;

  const cost = upgradeCost(100, shop.protection);
  if(money < cost) return;

  money -= cost;
  shop.protection++;

  if(shop.protection === 3) shop.salary += 0.5;
  if(shop.protection === 4) shop.salary += 0.8;

  buildSelectedShopUI();
}

function upgradeManagement(i){
  if(gamePhase !== "planning") return;
  const shop = shops[i];
  if(shop.management >= maxLevel) return;

  const cost = upgradeCost(80, shop.management);
  if(money < cost) return;

  money -= cost;
  shop.management++;

  if(shop.management === 3) shop.salary += 0.4;
  if(shop.management === 4) shop.salary += 0.6;

  buildSelectedShopUI();
}

function upgradeCCTV(){
  if(gamePhase !== "planning") return;
  if(cctvLevel >= maxLevel) return;

  const cost = upgradeCost(120, cctvLevel);
  if(money < cost) return;

  money -= cost;
  cctvLevel++;
  buildCCTVUI();
}

/* ======================
   PHASE CONTROL
====================== */
function startWave(){
  if(gamePhase !== "planning") return;

  // reset shop heat each wave
  shops.forEach(shop => shop.theftCount = 0);

  waveStats = {
    mallRevenue: 0,
    theftLoss: 0,
    thefts: 0,
    offenders: new Set(),
    salaryPaid: 0,
    visitorTypes: { ordinary: 0, opportunist: 0, determined: 0 },
    theftsByType: { ordinary: 0, opportunist: 0, determined: 0 }
  };

  gamePhase = "wave";
  waveTimer = waveLength;
  setRightMode("wave");
}

function endWave(){
  gamePhase = "planning";
  waveNumber++;
  document.getElementById("waveNum").innerText = waveNumber;
  visitors = [];
}

/* ======================
   GUARDS
====================== */
  function addGuard(){
  if(gamePhase !== "planning") return;
  if(money < 150) return;

  placingGuard = true;
  canvas.style.cursor = "crosshair";
}

// CLICK HANDLER
canvas.addEventListener("click", function(e){

  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  // 1Ô∏è‚É£ GUARD PLACEMENT FIRST
  if(placingGuard && gamePhase === "planning"){
    guards.push({
      x: x,
      y: y,
      radius: 130
    });

    money -= 150;
    placingGuard = false;
    canvas.style.cursor = "default";
    return;
  }

  // 2Ô∏è‚É£ SHOP SELECTION
  for(let i = 0; i < shops.length; i++){
    const shop = shops[i];
    const node = nodes[shop.node];

    if(Math.hypot(x - node.x, y - node.y) < 60){
      selectedShopIndex = i;
      buildSelectedShopUI();
      return;
    }
  }

  // 3Ô∏è‚É£ CLICKED EMPTY SPACE ‚Üí DESELECT
  selectedShopIndex = null;
  buildSelectedShopUI();
});

// MOUSEMOVE HANDLER (SEPARATE)
canvas.addEventListener("mousemove", function(e){

  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  hoveredShopIndex = null;

  for(let i = 0; i < shops.length; i++){
    const shop = shops[i];
    const node = nodes[shop.node];

    if(Math.hypot(x - node.x, y - node.y) < 60){
      hoveredShopIndex = i;
      break;
    }
  }

});


/* ======================
   VISITOR LOGIC
====================== */
function spawnVisitor(){
  let type;
  const r = Math.random();

  if(waveNumber === 1){
    type = r < 0.60 ? "ordinary"
         : r < 0.90 ? "opportunist"
         : "determined";
  }
  else if(waveNumber === 2){
    type = r < 0.55 ? "ordinary"
         : r < 0.85 ? "opportunist"
         : "determined";
  }
  else{
    type = r < 0.45 ? "ordinary"
         : r < 0.75 ? "opportunist"
         : "determined";
 
  }
   waveStats.visitorTypes[type]++;
  
  const profiles = {
    ordinary:{ M:10, S:40, risk:1.5, effort:1.2, maxThefts:1 },
    opportunist:{ M:25, S:25, risk:1.0, effort:1.0, maxThefts:2 },
    determined:{ M:40, S:10, risk:0.5, effort:1.5, maxThefts: (waveNumber === 1 ? 2 : 4) }
  };

  const p = profiles[type];

 const spawnNode = Math.random() < 0.7 
  ? "entranceMain" 
  : "entranceSide";

visitors.push({
  x: nodes[spawnNode].x,
  y: nodes[spawnNode].y,

  currentNode: spawnNode,
  targetNode: "hub",
  
  speed: 60,
  type: type,

  baseS: p.S,
  M: p.M,
  S: p.S,
  O: 20,
  R: 0,

  riskSensitivity: p.risk,
  effortSensitivity: p.effort,

  theftsCommitted: 0,
  maxThefts: p.maxThefts,

  visitedShops: {},
  finished: false
});
}

/* ======================
   UPDATE
====================== */
function update(dt){
  if(gamePhase === "wave"){
    waveTimer -= dt;

    if(waveTimer > waveLength * 0.4){
      if(Math.random() < 0.04) spawnVisitor();
    }

    visitors.forEach(v=>{
      moveVisitor(v,dt);
      applySecurity(v);
      checkShops(v);
    });

    const salaryThisFrame = getTotalSalaryPerSec() * dt;
    money -= salaryThisFrame;
    waveStats.salaryPaid = (waveStats.salaryPaid || 0) + salaryThisFrame;

    visitors = visitors.filter(v => !v.finished);

    if(waveTimer <= 0 && visitors.length === 0){
      endWave();
    }
  }
}

function moveVisitor(v, dt){

  if(v.finished) return;

  const target = nodes[v.targetNode];

  const dx = target.x - v.x;
  const dy = target.y - v.y;
  const dist = Math.hypot(dx, dy);
  const step = v.speed * dt;

  // If close enough, snap to node
  if(dist <= step){

    v.x = target.x;
    v.y = target.y;

    v.currentNode = v.targetNode;

    decideNextNode(v);

  } else {

    v.x += dx / dist * step;
    v.y += dy / dist * step;

  }
}
  function decideNextNode(v){

  const current = nodes[v.currentNode];

  // If at an entrance and already returned once, exit
  if(
    (v.currentNode === "entranceMain" || v.currentNode === "entranceSide") &&
    v.visitedHub
  ){
    v.finished = true;
    return;
  }

  // HUB logic (decision node)
  if(current.type === "decision"){

    v.visitedHub = true;

    // --- circulation probability ---
    let pShop = 0.45;

    if(v.theftsCommitted < v.maxThefts) pShop += 0.20;
    if(v.type === "determined") pShop += 0.15;
    if(v.type === "ordinary")   pShop -= 0.10;

    pShop = Math.max(0.05, Math.min(0.85, pShop));

    // visit a shop?
    if(Math.random() < pShop){

      const shopNodes = current.connections.filter(id => nodes[id].type === "shop");

      const unvisited = shopNodes.filter((nodeId)=>{
        const idx = shops.findIndex(s => s.node === nodeId);
        return idx === -1 ? true : !v.visitedShops[idx];
      });

      const pickFrom = unvisited.length ? unvisited : shopNodes;
      const randomShop = pickFrom[Math.floor(Math.random() * pickFrom.length)];

      v.targetNode = randomShop;
      return;
    }

    // otherwise go to nearest entrance
    const distMain = Math.hypot(v.x - nodes.entranceMain.x, v.y - nodes.entranceMain.y);
    const distSide = Math.hypot(v.x - nodes.entranceSide.x, v.y - nodes.entranceSide.y);

    v.targetNode = (distMain < distSide) ? "entranceMain" : "entranceSide";
    return;
  } // ‚úÖ <-- this closing brace was missing / in the wrong place

  // If at shop, go back to hub
  if(current.type === "shop"){
    v.targetNode = "hub";
    return;
  }

  // Default: go to hub
  v.targetNode = "hub";
}

function applySecurity(v){
  v.R = cctvLevel * 5;
  v.S = v.baseS;

  guards.forEach(g=>{
    if(Math.hypot(v.x-g.x,v.y-g.y) < g.radius){
      v.R += 15;
      v.S -= 5;
    }
  });

  v.S = Math.max(0, v.S);
}

function checkShops(v){

  shops.forEach((shop, index)=>{

    // Skip if already visited
    if(v.visitedShops[index]) return;

    // Get node position for this shop
    const node = nodes[shop.node];

    // Detect proximity to node
    const interactionRadius = 60;

    if(Math.hypot(v.x - node.x, v.y - node.y) < interactionRadius){

      v.visitedShops[index] = true;

      // Adjust opportunity & motivation
      v.O = shop.baseOpportunity - shop.protection * 5 * v.effortSensitivity;
      v.M -= shop.management * 2;

      const theftScore = v.M + v.O - (v.R * v.riskSensitivity);

      /* ======================
         THEFT
      ====================== */
      if(v.theftsCommitted < v.maxThefts && theftScore > 30){

  const theftLoss = shop.value * 0.75;

  money -= theftLoss;
  reputation -= 2;

  waveStats.theftLoss += theftLoss;
  waveStats.thefts++;
  waveStats.theftsByType[v.type]++;
  waveStats.offenders.add(v);

  shop.theftCount++;   // üî¥ ADD THIS

  v.theftsCommitted++;
}

      /* ======================
         LEGITIMATE PURCHASE
      ====================== */
      else if(v.S > v.M){

        const mallShare = shop.value * 0.30;

        money += mallShare;
        reputation += 1;

        waveStats.mallRevenue += mallShare;

      }

    }

  });

}

/* ======================
   DRAW
====================== */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // === Draw corridors (graph connections) ===
  ctx.strokeStyle = "#444";
  ctx.lineWidth = 40;
  ctx.lineCap = "round";

 Object.values(nodes).forEach(node=>{
  node.connections.forEach(targetId=>{
    if(node.id < targetId){   // prevents duplicate drawing
      const target = nodes[targetId];

      ctx.beginPath();
      ctx.moveTo(node.x, node.y);
      ctx.lineTo(target.x, target.y);
      ctx.stroke();
    }
  });
});
ctx.shadowBlur = 0;
ctx.shadowColor = "transparent";
ctx.font = "12px Arial";
ctx.textAlign = "center";
ctx.textBaseline = "middle";
// MAIN ENTRANCE
ctx.fillStyle = "#2e7d32"; // green tone
ctx.beginPath();
ctx.arc(nodes.entranceMain.x, nodes.entranceMain.y, 35, 0, Math.PI*2);
ctx.fill();

ctx.fillStyle = "#fff";
ctx.fillText("MAIN", nodes.entranceMain.x, nodes.entranceMain.y);
  
  // SIDE ENTRANCE
ctx.fillStyle = "#455a64"; // cooler grey-blue
ctx.beginPath();
ctx.arc(nodes.entranceSide.x, nodes.entranceSide.y, 25, 0, Math.PI*2);
ctx.fill();

ctx.fillStyle = "#fff";
ctx.fillText("SIDE", nodes.entranceSide.x, nodes.entranceSide.y);

  // === Draw shops at their node positions ===
  shops.forEach((shop, i)=>{
  const node = nodes[shop.node];

  const isSelected = (i === selectedShopIndex);
  const isHovered = (i === hoveredShopIndex);

  let fill = "#333";
  if(isHovered) fill = "#444";
  if(isSelected) fill = "#555";

  // üî¥ Crime heat glow
  if(shop.theftCount > 0){
    const intensity = Math.min(shop.theftCount * 5, 40);
    ctx.shadowColor = "rgba(255,0,0,0.7)";
    ctx.shadowBlur = intensity;
  }

  ctx.fillStyle = fill;
  ctx.fillRect(node.x - 50, node.y - 30, 100, 60);

  ctx.shadowBlur = 0;

  if(isSelected){
    ctx.strokeStyle = "#4caf50";
    ctx.lineWidth = 4;
    ctx.strokeRect(node.x - 55, node.y - 35, 110, 70);
  }

  ctx.fillStyle = "#fff";
  ctx.fillText(shop.name, node.x, node.y);
});

  guards.forEach(g=>{
    ctx.strokeStyle="rgba(0,200,255,0.3)";
    ctx.beginPath();
    ctx.arc(g.x,g.y,g.radius,0,Math.PI*2);
    ctx.stroke();
    ctx.fillStyle="#0ff";
    ctx.fillRect(g.x-6,g.y-6,12,12);
  });

  visitors.forEach(v=>{
    ctx.fillStyle=v.type==="ordinary"?"#0f0"
               : v.type==="opportunist"?"#ff0":"#f00";
    ctx.beginPath();
    ctx.arc(v.x,v.y,8,0,Math.PI*2);
    ctx.fill();
  });

  document.getElementById("money").innerText = Math.round(money);
  document.getElementById("rep").innerText = Math.round(reputation);
  document.getElementById("visitors").innerText = visitors.length;
  document.getElementById("phaseDisplay").innerText =
    gamePhase === "planning" ? "Planning" : "Wave Active";

  const totalSalary = (gamePhase === "wave") ? getTotalSalaryPerSec() : 0;
  document.getElementById("salaryDisplay").innerText =
    totalSalary.toFixed(1) + "/sec";

  // Right panel: wave view updates live (only if wave tab selected or wave mode visible)
  if(gamePhase === "wave"){
    const net = waveStats.mallRevenue - waveStats.theftLoss - waveStats.salaryPaid;

    let netColor = "#aaa";
    if(net > 0) netColor = "#4caf50";
    else if(net < 0) netColor = "#e53935";

    document.getElementById("analyticsPanel").innerHTML = `
      <b>Revenue</b><br>
      Mall Revenue: ¬£${waveStats.mallRevenue.toFixed(0)}<br><br>

      <b>Costs</b><br>
      Salary: ¬£${waveStats.salaryPaid.toFixed(0)}<br>
      Theft Loss: ¬£${waveStats.theftLoss.toFixed(0)}<br><br>

      <b>Crime</b><br>
      Thefts: ${waveStats.thefts}<br>
      Offenders: ${waveStats.offenders.size}<br><br>
      <b>Visitors</b><br>
      Ordinary: ${waveStats.visitorTypes.ordinary}<br>
      Opportunist: ${waveStats.visitorTypes.opportunist}<br>
      Determined: ${waveStats.visitorTypes.determined}<br><br>

      <b>Thefts by type</b><br>
      Ordinary: ${waveStats.theftsByType.ordinary}<br>
      Opportunist: ${waveStats.theftsByType.opportunist}<br>
      Determined: ${waveStats.theftsByType.determined}<br><br>

      <div style="font-size:16px; color:${netColor}">
        Net: ¬£${net.toFixed(0)}
      </div>
    `;
  } else {
    document.getElementById("analyticsPanel").innerHTML = "Start a wave to see results.";
  }
}

/* ======================
   GAME LOOP
====================== */
let last=0;
function loop(t){
  const dt=(t-last)/1000;
  last=t;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

// Build UI and start
buildSelectedShopUI();
buildCCTVUI();
setRightMode("wave");
loop(0);
</script>
</body>
</html>



















