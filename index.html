<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Mall Manager ‚Äì Phase 3</title>
<style>
body {
  margin:0;
  background:#111;
  color:#eee;
  font-family:Arial;
  display:flex;
}

#game { flex:1; display:block; }

#ui {
  width:320px;
  background:#1b1b1b;
  border-left:1px solid #333;
  padding:12px;
  overflow-y:auto;
}

button {
  width:100%;
  margin-top:6px;
  padding:6px;
}

.stat { margin:4px 0; }
.shopBlock {
  margin-top:12px;
  border-top:1px solid #333;
  padding-top:8px;
}
.small { font-size:12px; color:#aaa; }
</style>
</head>
<body>

<div id="ui">
  <div class="stat">üí∞ Money: <span id="money"></span></div>
  <div class="stat">‚≠ê Reputation: <span id="rep"></span></div>
  <div class="stat">üë• Visitors: <span id="visitors"></span></div>
  <div class="stat">üíº Wave Salary: <span id="salaryDisplay"></span></div>

  <hr>
  <div>Wave: <span id="waveNum">1</span></div>
  <div>Phase: <span id="phaseDisplay">Planning</span></div>
  <button onclick="startWave()">Start Wave</button>

  <hr>
  <b>Global Surveillance</b>
  <div id="cctvPanel"></div>
  <button onclick="addGuard()">Place Guard (¬£150)</button>

  <div id="shopControls"></div>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
  canvas.width = window.innerWidth - 320;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

/* ======================
   GAME STATE
====================== */
let money = 600;
let reputation = 50;
let placingGuard = false;

let gamePhase = "planning";
let waveTimer = 0;
let waveLength = 30;
let waveNumber = 1;

let cctvLevel = 0;
const maxLevel = 4;

const path = [
  {x:200,y:200},  // Entrance
  {x:900,y:200},
  {x:900,y:700},
  {x:200,y:700},
  {x:200,y:200}   // Exit (back to entrance)
];

/* ======================
   UPGRADE DATA
====================== */
const managementLevels = [
  "Basic Layout",
  "Clear Anti-Theft Signage",
  "Improved Lighting",
  "Staff Training",
  "Active Customer Engagement"
];

const cctvLevels = [
  "No CCTV",
  "Visible Cameras",
  "Monitored Cameras",
  "AI Detection System",
  "Integrated Security Network"
];

const protectionLevels = {
  Electronics:[
    "Open Display Tables",
    "Security Tags",
    "Locked Cabinets",
    "Staff-Assisted Sales",
    "Smart Anti-Theft System"
  ],
  Jewellery:[
    "Open Counter",
    "Glass Display Case",
    "Locked Case",
    "Staff-Controlled Viewing",
    "Secure Vault Storage"
  ],
  Clothing:[
    "Open Racks",
    "Security Tags",
    "Fitting Room Monitoring",
    "Item Check System",
    "Controlled Entry System"
  ],
  "Food Court":[
    "Open Counter Service",
    "Staff Supervision",
    "Queue Management",
    "Controlled Payment Area",
    "Cashless Payment Only"
  ]
};

/* ======================
   SHOPS
====================== */
const shops = [
  {name:"Electronics", x:550,y:200,value:70,baseOpportunity:25,protection:0,management:0,salary:0},
  {name:"Clothing", x:900,y:450,value:40,baseOpportunity:20,protection:0,management:0,salary:0},
  {name:"Jewellery", x:550,y:700,value:100,baseOpportunity:35,protection:0,management:0,salary:0},
  {name:"Food Court", x:200,y:450,value:20,baseOpportunity:10,protection:0,management:0,salary:0}
];

const guards = [];
let visitors = [];

/* ======================
   COST CALC
====================== */
function upgradeCost(base, level){
  return base * (level + 1);
}

/* ======================
   SALARY HELPERS
====================== */
function getGuardSalaryPerSec(){
  return guards.length * 1; // unchanged per your request
}

function getShopSalaryPerSec(){
  return shops.reduce((sum, s) => sum + (s.salary || 0), 0);
}

function getTotalSalaryPerSec(){
  return getGuardSalaryPerSec() + getShopSalaryPerSec();
}

/* ======================
   UI BUILDERS
====================== */
function buildShopUI(){
  const container = document.getElementById("shopControls");
  container.innerHTML = "";

  shops.forEach((shop,i)=>{

    const protectionText = protectionLevels[shop.name][shop.protection];
    const managementText = managementLevels[shop.management];

    const protectionCost = shop.protection < maxLevel ?
      upgradeCost(100, shop.protection) : null;

    const managementCost = shop.management < maxLevel ?
      upgradeCost(80, shop.management) : null;

    const div = document.createElement("div");
    div.className="shopBlock";
    div.innerHTML = `
      <b>${shop.name}</b>

      <div class="small">
        Product Protection: Level ${shop.protection}<br>
        ${protectionText}
      </div>
      ${shop.protection < maxLevel ?
        `<button onclick="upgradeProtection(${i})">
          Upgrade Protection (¬£${protectionCost})
        </button>` : "<div class='small'>Max Level</div>"}

      <div class="small">
        Store Management: Level ${shop.management}<br>
        ${managementText}
      </div>
      ${shop.management < maxLevel ?
        `<button onclick="upgradeManagement(${i})">
          Upgrade Management (¬£${managementCost})
        </button>` : "<div class='small'>Max Level</div>"}

      <div class="small">
        Staff Cost During Wave: ¬£${(shop.salary || 0).toFixed(1)} / sec
      </div>
    `;
    container.appendChild(div);
  });
}

function buildCCTVUI(){
  const panel = document.getElementById("cctvPanel");
  const text = cctvLevels[cctvLevel];
  const cost = cctvLevel < maxLevel ?
    upgradeCost(120, cctvLevel) : null;

  panel.innerHTML = `
    <div class="small">
      CCTV Level ${cctvLevel}<br>
      ${text}
    </div>
    ${cctvLevel < maxLevel ?
      `<button onclick="upgradeCCTV()">Upgrade CCTV (¬£${cost})</button>`
      : "<div class='small'>Max Level</div>"}
  `;
}

/* ======================
   UPGRADES
====================== */
function upgradeProtection(i){
  if(gamePhase !== "planning") return;
  const shop = shops[i];
  if(shop.protection >= maxLevel) return;

  const cost = upgradeCost(100, shop.protection);
  if(money < cost) return;

  money -= cost;
  shop.protection++;

  // Staff-based protection levels
  if(shop.protection === 3) shop.salary += 0.5;
  if(shop.protection === 4) shop.salary += 0.8;

  buildShopUI();
}

function upgradeManagement(i){
  if(gamePhase !== "planning") return;
  const shop = shops[i];
  if(shop.management >= maxLevel) return;

  const cost = upgradeCost(80, shop.management);
  if(money < cost) return;

  money -= cost;
  shop.management++;

  // Staff-heavy management levels
  if(shop.management === 3) shop.salary += 0.4;
  if(shop.management === 4) shop.salary += 0.6;

  buildShopUI();
}

function upgradeCCTV(){
  if(gamePhase !== "planning") return;
  if(cctvLevel >= maxLevel) return;

  const cost = upgradeCost(120, cctvLevel);
  if(money < cost) return;

  money -= cost;
  cctvLevel++;
  buildCCTVUI();
}

/* ======================
   PHASE CONTROL
====================== */
function startWave(){
  if(gamePhase !== "planning") return;
  gamePhase = "wave";
  waveTimer = waveLength;
}

function endWave(){
  gamePhase = "planning";
  waveNumber++;
  document.getElementById("waveNum").innerText = waveNumber;
  visitors = [];
}

/* ======================
   GUARDS
====================== */
canvas.addEventListener("click", function(e){
  if(!placingGuard || gamePhase !== "planning") return;

  const rect = canvas.getBoundingClientRect();
  guards.push({
    x: e.clientX - rect.left,
    y: e.clientY - rect.top,
    radius:130
  });

  money -= 150;
  placingGuard = false;
});

function addGuard(){
  if(gamePhase !== "planning") return;
  if(money < 150) return;
  placingGuard = true;
}

/* ======================
   VISITOR LOGIC
====================== */
function spawnVisitor(){
  let type;
  const r = Math.random();

  // Wave-based mix
  if(waveNumber === 1){
    type = r < 0.60 ? "ordinary"
         : r < 0.90 ? "opportunist"
         : "determined";
  }
  else if(waveNumber === 2){
    type = r < 0.55 ? "ordinary"
         : r < 0.85 ? "opportunist"
         : "determined";
  }
  else{
    type = r < 0.45 ? "ordinary"
         : r < 0.75 ? "opportunist"
         : "determined";
  }

  const profiles = {
    ordinary:{ M:10, S:40, risk:1.5, effort:1.2, maxThefts:1 },
    opportunist:{ M:25, S:25, risk:1.0, effort:1.0, maxThefts:2 },
    determined:{ M:40, S:10, risk:0.5, effort:1.5, maxThefts: (waveNumber === 1 ? 2 : 4) }
  };

  const p = profiles[type];

  visitors.push({
    x:200, y:200,
    pathIndex:0,
    speed:60,
    type:type,

    baseS:p.S,
    M:p.M,
    S:p.S,
    O:20,
    R:0,

    riskSensitivity:p.risk,
    effortSensitivity:p.effort,

    theftsCommitted:0,
    maxThefts:p.maxThefts,

    visitedShops:{}
  });
}

/* ======================
   UPDATE
====================== */
function update(dt){
  if(gamePhase === "wave"){
    waveTimer -= dt;

    // Only spawn during first 60% of wave
    if(waveTimer > waveLength * 0.4){
      if(Math.random() < 0.04) spawnVisitor();
    }

    visitors.forEach(v=>{
      moveVisitor(v,dt);
      applySecurity(v);
      checkShops(v);
    });

    // Salary only during wave (guards + staff-based upgrades)
    money -= getTotalSalaryPerSec() * dt;

    // Remove finished visitors
    visitors = visitors.filter(v => v.pathIndex < path.length);

    // Only end wave when timer expired AND no visitors remain
    if(waveTimer <= 0 && visitors.length === 0){
      endWave();
    }
  }
}

function moveVisitor(v,dt){

  // If reached final node, mark complete
  if(v.pathIndex >= path.length - 1){
    v.pathIndex = path.length;
    return;
  }

  const next = path[v.pathIndex + 1];
  const dx = next.x - v.x;
  const dy = next.y - v.y;
  const dist = Math.hypot(dx,dy);

  if(dist < 2){
    v.pathIndex++;
  }
  else{
    v.x += dx/dist * v.speed * dt;
    v.y += dy/dist * v.speed * dt;
  }
}


function applySecurity(v){
  v.R = cctvLevel * 5;
  v.S = v.baseS;

  guards.forEach(g=>{
    if(Math.hypot(v.x-g.x,v.y-g.y) < g.radius){
      v.R += 15;
      v.S -= 5;
    }
  });

  v.S = Math.max(0, v.S);
}

function checkShops(v){
  shops.forEach((shop, index)=>{
    if(v.visitedShops[index]) return;

    if(Math.hypot(v.x-shop.x, v.y-shop.y) < 60){
      v.visitedShops[index] = true;

      v.O = shop.baseOpportunity - shop.protection * 5 * v.effortSensitivity;
      v.M -= shop.management * 2;

      const theftScore = v.M + v.O - (v.R * v.riskSensitivity);

      if(v.theftsCommitted < v.maxThefts && theftScore > 30){
        const theftLoss = shop.value * 0.75;
        money -= theftLoss;
        reputation -= 2;
        v.theftsCommitted++; // IMPORTANT: count thefts

        // Emboldening placeholder (refine later)
        if(v.type === "determined"){
          v.M += 5;
        }
      }
      else if(v.S > v.M){

  // Mall only earns percentage of shop sales
  const mallShare = shop.value * 0.30;
  money += mallShare;

  reputation += 1;
}

    }
  });
}

/* ======================
   DRAW
====================== */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.strokeStyle="#444";
  ctx.lineWidth=40;
  ctx.beginPath();
  ctx.moveTo(path[0].x,path[0].y);
  path.forEach(p=>ctx.lineTo(p.x,p.y));
  ctx.closePath();
  ctx.stroke();

  shops.forEach(shop=>{
    ctx.fillStyle="#333";
    ctx.fillRect(shop.x-50,shop.y-30,100,60);
    ctx.fillStyle="#fff";
    ctx.fillText(shop.name,shop.x-40,shop.y);
  });

  guards.forEach(g=>{
    ctx.strokeStyle="rgba(0,200,255,0.3)";
    ctx.beginPath();
    ctx.arc(g.x,g.y,g.radius,0,Math.PI*2);
    ctx.stroke();
    ctx.fillStyle="#0ff";
    ctx.fillRect(g.x-6,g.y-6,12,12);
  });

  visitors.forEach(v=>{
    ctx.fillStyle=v.type==="ordinary"?"#0f0"
               : v.type==="opportunist"?"#ff0":"#f00";
    ctx.beginPath();
    ctx.arc(v.x,v.y,8,0,Math.PI*2);
    ctx.fill();
  });

  document.getElementById("money").innerText = Math.round(money);
  document.getElementById("rep").innerText = Math.round(reputation);
  document.getElementById("visitors").innerText = visitors.length;
  document.getElementById("phaseDisplay").innerText =
    gamePhase === "planning" ? "Planning" : "Wave Active";

  const totalSalary = (gamePhase === "wave") ? getTotalSalaryPerSec() : 0;
  document.getElementById("salaryDisplay").innerText =
    totalSalary.toFixed(1) + "/sec";
}

let last=0;
function loop(t){
  const dt=(t-last)/1000;
  last=t;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

buildShopUI();
buildCCTVUI();
loop(0);
</script>
</body>
</html>




