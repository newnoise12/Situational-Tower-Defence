<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Mall Manager ‚Äì Multi Shop</title>
<style>
body {
  margin:0;
  background:#111;
  color:#eee;
  font-family:Arial;
  display:flex;
}

#game {
  flex:1;
  display:block;
}

#ui {
  width:300px;
  background:#1b1b1b;
  border-left:1px solid #333;
  padding:12px;
  overflow-y:auto;
}

button {
  width:100%;
  margin-top:6px;
  padding:6px;
}

.stat { margin:4px 0; }
.shopBlock {
  margin-top:8px;
  border-top:1px solid #333;
  padding-top:6px;
}
</style>
</head>
<body>

<div id="ui">
  <div class="stat">üí∞ Money: <span id="money"></span></div>
  <div class="stat">‚≠ê Reputation: <span id="rep"></span></div>
  <div class="stat">üë• Visitors: <span id="visitors"></span></div>

  <div id="shopControls"></div>

  <hr>
  <button onclick="addGuard()">Add Guard (¬£150)</button>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

/* -------------------------
   CANVAS RESIZING FIX
-------------------------- */
function resizeCanvas(){
  canvas.width = window.innerWidth - 300; // subtract UI panel width
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

/* -------------------------
   CORE VARIABLES
-------------------------- */
let money = 600;
let reputation = 50;
let placingGuard = false;

const path = [
  {x:200,y:200},{x:900,y:200},
  {x:900,y:700},{x:200,y:700}
];

const shops = [
  {name:"Electronics", x:550,y:200,value:70,baseOpportunity:25,hardening:0,signage:0,environment:0},
  {name:"Clothing", x:900,y:450,value:40,baseOpportunity:20,hardening:0,signage:0,environment:0},
  {name:"Jewellery", x:550,y:700,value:100,baseOpportunity:35,hardening:0,signage:0,environment:0},
  {name:"Food Court", x:200,y:450,value:20,baseOpportunity:10,hardening:0,signage:0,environment:0}
];

const guards = [];
let visitors = [];

/* -------------------------
   GUARD PLACEMENT
-------------------------- */
canvas.addEventListener("click", function(e){
  if(!placingGuard) return;

  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  guards.push({x:x, y:y, radius:130});
  money -= 150;
  placingGuard = false;
});

function addGuard(){
  if(money < 150) return;
  placingGuard = true;
}

/* -------------------------
   SHOP UI
-------------------------- */
function buildShopUI(){
  const container = document.getElementById("shopControls");
  container.innerHTML = "";
  shops.forEach((shop,i)=>{
    const div = document.createElement("div");
    div.className="shopBlock";
    div.innerHTML = `
      <b>${shop.name}</b><br>
      <button onclick="upgradeShop(${i},'hardening')">+ Hardening (¬£100)</button>
      <button onclick="upgradeShop(${i},'signage')">+ Signage (¬£80)</button>
      <button onclick="upgradeShop(${i},'environment')">+ Environment (¬£80)</button>
    `;
    container.appendChild(div);
  });
}

function upgradeShop(i,type){
  const shop=shops[i];
  const cost=100;
  if(money<cost)return;
  money-=cost;
  shop[type]++;
}

/* -------------------------
   VISITOR SPAWNING
-------------------------- */
function spawnVisitor(){
  const roll=Math.random();
  let type;

  if(reputation>70)
    type=roll<0.7?"ordinary":roll<0.95?"opportunist":"determined";
  else if(reputation<30)
    type=roll<0.3?"ordinary":roll<0.7?"opportunist":"determined";
  else
    type=roll<0.5?"ordinary":roll<0.85?"opportunist":"determined";

  const profiles={
    ordinary:{M:10,S:40,risk:1.5,effort:1.2,excuse:1.5},
    opportunist:{M:25,S:25,risk:1.0,effort:1.0,excuse:1.0},
    determined:{M:40,S:10,risk:0.5,effort:1.5,excuse:0.5}
  };

  const p=profiles[type];

  visitors.push({
    x:200,y:200,
    pathIndex:0,
    speed:60,
    type,
    baseS:p.S,
    M:p.M,
    S:p.S,
    O:20,
    R:0,
    riskSensitivity:p.risk,
    effortSensitivity:p.effort,
    excuseSensitivity:p.excuse,
    attempted:false
  });
}

/* -------------------------
   UPDATE LOOP
-------------------------- */
function update(dt){

  if(Math.random()<0.02) spawnVisitor();

  visitors.forEach(v=>{
    moveVisitor(v,dt);
    applySecurity(v,dt);
    checkShops(v);
  });

  // Guard salary (charged once per frame)
  money -= guards.length * 0.5 * dt;

  // Remove visitors who finished loop
  visitors = visitors.filter(v => v.pathIndex < path.length);
}

/* -------------------------
   MOVEMENT
-------------------------- */
function moveVisitor(v,dt){
  const next=path[(v.pathIndex+1)%path.length];
  const dx=next.x-v.x,dy=next.y-v.y;
  const dist=Math.hypot(dx,dy);

  if(dist<2){
    v.pathIndex++;
  } else {
    v.x+=dx/dist*v.speed*dt;
    v.y+=dy/dist*v.speed*dt;
  }
}

/* -------------------------
   SECURITY EFFECTS
-------------------------- */
function applySecurity(v,dt){
  v.R = 0;
  v.S = v.baseS; // reset spending each frame

  guards.forEach(g=>{
    const d = Math.hypot(v.x-g.x, v.y-g.y);
    if(d < g.radius){
      v.R += 15;
      v.S -= 5; // comfort penalty
    }
  });

  // prevent negative spending
  v.S = Math.max(0, v.S);
}

/* -------------------------
   SHOP INTERACTION
-------------------------- */
function checkShops(v){
  if(v.attempted) return;

  shops.forEach(shop=>{
    if(Math.hypot(v.x-shop.x,v.y-shop.y)<60){

      v.O = shop.baseOpportunity - shop.hardening*5*v.effortSensitivity;
      v.M -= shop.environment*1;
      v.M -= shop.signage*3*v.excuseSensitivity;

      if(shop.name==="Food Court"){
        v.S += 10;
      }

      const theftScore = v.M + v.O - (v.R*v.riskSensitivity);

      if(theftScore>30){
        money -= shop.value;
        reputation -= 5;
      }
      else if(v.S > v.M){
        money += shop.value;
        reputation += 1;
      }

      v.attempted=true;
    }
  });
}

/* -------------------------
   DRAW
-------------------------- */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.strokeStyle="#444";
  ctx.lineWidth=40;
  ctx.beginPath();
  ctx.moveTo(path[0].x,path[0].y);
  path.forEach(p=>ctx.lineTo(p.x,p.y));
  ctx.closePath();
  ctx.stroke();

  shops.forEach(shop=>{
    ctx.fillStyle="#333";
    ctx.fillRect(shop.x-50,shop.y-30,100,60);
    ctx.fillStyle="#fff";
    ctx.fillText(shop.name,shop.x-40,shop.y);
  });

  guards.forEach(g=>{
    ctx.strokeStyle="rgba(0,200,255,0.3)";
    ctx.beginPath();
    ctx.arc(g.x,g.y,g.radius,0,Math.PI*2);
    ctx.stroke();

    ctx.fillStyle="#0ff";
    ctx.fillRect(g.x-6,g.y-6,12,12);
  });

  visitors.forEach(v=>{
    ctx.fillStyle=v.type==="ordinary"?"#0f0":
                   v.type==="opportunist"?"#ff0":"#f00";
    ctx.beginPath();
    ctx.arc(v.x,v.y,8,0,Math.PI*2);
    ctx.fill();
  });

  document.getElementById("money").innerText=Math.round(money);
  document.getElementById("rep").innerText=Math.round(reputation);
  document.getElementById("visitors").innerText=visitors.length;
}

/* -------------------------
   GAME LOOP
-------------------------- */
let last=0;
function loop(t){
  const dt=(t-last)/1000;
  last=t;
  update(dt);
  draw();
  requestAnimationFrame(loop)

</script>
</body>
</html>



