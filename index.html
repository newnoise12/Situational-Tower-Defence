<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Mall Manager ‚Äì Phase 3</title>
<style>
body {
  margin:0;
  background:#111;
  color:#eee;
  font-family:Arial;
  display:flex;
  height:100vh;
  overflow:hidden;
}

/* LEFT PANEL */
#ui {
  width:320px;
  background:#1b1b1b;
  border-right:1px solid #333;
  padding:12px;
  overflow-y:auto;
}

/* CENTER CANVAS */
#game {
  flex:1;
  display:block;
}

/* RIGHT PANEL */
#analyticsBox {
  width:260px;
  background:#1a1a1a;
  border-left:1px solid #333;
  padding:12px;
  overflow-y:auto;
}

#analyticsBox h3{
  margin:0 0 8px 0;
}

.rightTabs{
  display:flex;
  gap:8px;
  margin-bottom:10px;
}
.rightTabs button{
  flex:1;
  padding:8px;
  margin:0;
}

button {
  width:100%;
  margin-top:6px;
  padding:6px;
}

.stat { margin:4px 0; }

.shopBlock {
  margin-top:12px;
  border-top:1px solid #333;
  padding-top:8px;
}

.small { font-size:12px; color:#aaa; }

.row {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
}

.infoBtn{
  width:auto;
  padding:2px 8px;
  margin:0;
  font-size:12px;
  cursor:pointer;
  background:#2a2a2a;
  border:1px solid #444;
  color:#ddd;
  border-radius:6px;
}
.infoBtn:hover{
  background:#333;
}

/* Floating tooltip */
#tooltip{
  position:fixed;
  pointer-events:none;
  background:rgba(20,20,20,0.96);
  border:1px solid #444;
  padding:8px 10px;
  border-radius:10px;
  font-size:12px;
  color:#eee;
  max-width:260px;
  line-height:1.3;
  display:none;
  z-index:9999;
  box-shadow:0 8px 22px rgba(0,0,0,0.35);
}
#tooltip .muted{ color:#aaa; font-size:11px; }

</style>
</head>
<body>

<!-- LEFT PANEL -->
<div id="ui">

  <div class="stat">üí∞ Money: <span id="money"></span></div>
  <div class="stat">‚≠ê Reputation: <span id="rep"></span></div>
  <div class="stat">üë• Visitors: <span id="visitors"></span></div>
  <div class="stat">üíº Wave Salary: <span id="salaryDisplay"></span></div>

  <hr>

  <div>Wave: <span id="waveNum">1</span></div>
  <div>Phase: <span id="phaseDisplay">Planning</span></div>
  <button onclick="startWave()">Start Wave</button>

  <hr>

  <div class="row">
    <b>Global Surveillance</b>
    <button class="infoBtn"
      onmouseenter="showTooltip(event,'cctv')"
      onmousemove="moveTooltip(event)"
      onmouseleave="hideTooltip()"
      onclick="showInfoPanel('cctv')"
      title="More info"
    >‚Ñπ</button>
  </div>

  <div id="cctvPanel"></div>

  <div class="row" style="margin-top:10px;">
    <button onclick="addGuard()">Place Guard (¬£150)</button>
    <button class="infoBtn"
      onmouseenter="showTooltip(event,'guards')"
      onmousemove="moveTooltip(event)"
      onmouseleave="hideTooltip()"
      onclick="showInfoPanel('guards')"
      title="More info"
    >‚Ñπ</button>
  </div>

  <div id="shopControls"></div>

</div>

<!-- CENTER CANVAS -->
<canvas id="game"></canvas>

<!-- RIGHT PANEL -->
<div id="analyticsBox">
  <h3 id="rightTitle">Wave Overview</h3>

  <div class="rightTabs">
    <button onclick="setRightMode('wave')">Wave Overview</button>
    <button onclick="setRightMode('info')">Security Info</button>
  </div>

  <div id="analyticsPanel" class="small">Start a wave to see results.</div>
  <div id="infoPanel" class="small" style="display:none;">
    Click any ‚Ñπ button to see details here.
  </div>
</div>

<!-- floating tooltip -->
<div id="tooltip"></div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
  canvas.width = window.innerWidth - 320 - 260;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

/* ======================
   GAME STATE
====================== */
let money = 600;
let reputation = 50;
let placingGuard = false;

let gamePhase = "planning";
let waveTimer = 0;
let waveLength = 30;
let waveNumber = 1;

let cctvLevel = 0;
const maxLevel = 4;

const path = [
  {x:200,y:200},  // Entrance
  {x:900,y:200},
  {x:900,y:700},
  {x:200,y:700},
  {x:200,y:200}   // Exit (back to entrance)
];

// üîπ Wave analytics (persistent reference)
let waveStats = {
  mallRevenue: 0,
  theftLoss: 0,
  thefts: 0,
  offenders: new Set(),
  salaryPaid: 0
};

/* ======================
   INFO TEXT (SECURITY HELP)
====================== */
const infoText = {
  cctv: `
    <b>Surveillance (CCTV)</b><br>
    Increases <b>perceived risk</b> (R).<br><br>
    <span class="muted">
    ‚Ä¢ Works best on risk-sensitive visitors<br>
    ‚Ä¢ Helps across the whole mall<br>
    ‚Ä¢ Less effective against highly motivated offenders
    </span>
  `,
  guards: `
    <b>Security Guards</b><br>
    Strong local deterrent (big R boost in range).<br><br>
    <span class="muted">
    ‚Ä¢ Powerful near the guard radius<br>
    ‚Ä¢ Helps reduce repeat offending pressure<br>
    ‚Ä¢ Costs money every second during a wave
    </span>
  `,
  protection: `
    <b>Product Protection</b><br>
    Reduces <b>opportunity</b> (O) for theft in a store.<br><br>
    <span class="muted">
    ‚Ä¢ Makes items harder to steal<br>
    ‚Ä¢ Strong vs opportunists<br>
    ‚Ä¢ Determined offenders may still try
    </span>
  `,
  management: `
    <b>Store Management</b><br>
    Reduces <b>motivation</b> (M) by improving staff presence/awareness.<br><br>
    <span class="muted">
    ‚Ä¢ Discourages casual theft<br>
    ‚Ä¢ Builds informal guardianship<br>
    ‚Ä¢ Higher levels can increase staffing cost
    </span>
  `
};

/* ======================
   RIGHT PANEL MODES
====================== */
let rightMode = "wave";

function setRightMode(mode){
  rightMode = mode;

  const analytics = document.getElementById("analyticsPanel");
  const info = document.getElementById("infoPanel");
  const title = document.getElementById("rightTitle");

  if(mode === "wave"){
    title.innerText = "Wave Overview";
    analytics.style.display = "block";
    info.style.display = "none";
  } else {
    title.innerText = "Security Info";
    analytics.style.display = "none";
    info.style.display = "block";
  }
}

function showInfoPanel(key, shopName){
  setRightMode("info");
  const panel = document.getElementById("infoPanel");

  // Optional: show which shop it's about
  const prefix = shopName ? `<div style="margin-bottom:6px;"><b>${shopName}</b></div>` : "";

  panel.innerHTML = `
    ${prefix}
    ${infoText[key] || "No info available."}
    <div class="muted" style="margin-top:8px;">
      Tip: Hover ‚Ñπ for a quick tooltip, click ‚Ñπ to pin the info here.
    </div>
  `;
}

/* ======================
   TOOLTIP
====================== */
const tooltip = document.getElementById("tooltip");

function showTooltip(e, key){
  tooltip.innerHTML = infoText[key] || "";
  tooltip.style.display = "block";
  moveTooltip(e);
}
function moveTooltip(e){
  const pad = 14;
  let x = e.clientX + pad;
  let y = e.clientY + pad;

  // keep on-screen
  const rect = tooltip.getBoundingClientRect();
  if(x + rect.width > window.innerWidth) x = e.clientX - rect.width - pad;
  if(y + rect.height > window.innerHeight) y = e.clientY - rect.height - pad;

  tooltip.style.left = x + "px";
  tooltip.style.top = y + "px";
}
function hideTooltip(){
  tooltip.style.display = "none";
}

/* ======================
   UPGRADE DATA
====================== */
const managementLevels = [
  "Basic Layout",
  "Clear Anti-Theft Signage",
  "Improved Lighting",
  "Staff Training",
  "Active Customer Engagement"
];

const cctvLevels = [
  "No CCTV",
  "Visible Cameras",
  "Monitored Cameras",
  "AI Detection System",
  "Integrated Security Network"
];

const protectionLevels = {
  Electronics:[
    "Open Display Tables",
    "Security Tags",
    "Locked Cabinets",
    "Staff-Assisted Sales",
    "Smart Anti-Theft System"
  ],
  Jewellery:[
    "Open Counter",
    "Glass Display Case",
    "Locked Case",
    "Staff-Controlled Viewing",
    "Secure Vault Storage"
  ],
  Clothing:[
    "Open Racks",
    "Security Tags",
    "Fitting Room Monitoring",
    "Item Check System",
    "Controlled Entry System"
  ],
  "Food Court":[
    "Open Counter Service",
    "Staff Supervision",
    "Queue Management",
    "Controlled Payment Area",
    "Cashless Payment Only"
  ]
};

/* ======================
   SHOPS
====================== */
const shops = [
  {name:"Electronics", x:550,y:200,value:70,baseOpportunity:25,protection:0,management:0,salary:0},
  {name:"Clothing", x:900,y:450,value:40,baseOpportunity:20,protection:0,management:0,salary:0},
  {name:"Jewellery", x:550,y:700,value:100,baseOpportunity:35,protection:0,management:0,salary:0},
  {name:"Food Court", x:200,y:450,value:20,baseOpportunity:10,protection:0,management:0,salary:0}
];

const guards = [];
let visitors = [];

/* ======================
   COST CALC
====================== */
function upgradeCost(base, level){
  return base * (level + 1);
}

/* ======================
   SALARY HELPERS
====================== */
function getGuardSalaryPerSec(){
  return guards.length * 1;
}

function getShopSalaryPerSec(){
  return shops.reduce((sum, s) => sum + (s.salary || 0), 0);
}

function getTotalSalaryPerSec(){
  return getGuardSalaryPerSec() + getShopSalaryPerSec();
}

/* ======================
   UI BUILDERS
====================== */
function buildShopUI(){
  const container = document.getElementById("shopControls");
  container.innerHTML = "";

  shops.forEach((shop,i)=>{

    const protectionText = protectionLevels[shop.name][shop.protection];
    const managementText = managementLevels[shop.management];

    const protectionCost = shop.protection < maxLevel ?
      upgradeCost(100, shop.protection) : null;

    const managementCost = shop.management < maxLevel ?
      upgradeCost(80, shop.management) : null;

    const div = document.createElement("div");
    div.className="shopBlock";

    div.innerHTML = `
      <div class="row">
        <b>${shop.name}</b>
      </div>

      <div class="row" style="margin-top:6px;">
        <div class="small">
          Product Protection: Level ${shop.protection}<br>
          ${protectionText}
        </div>
        <button class="infoBtn"
          onmouseenter="showTooltip(event,'protection')"
          onmousemove="moveTooltip(event)"
          onmouseleave="hideTooltip()"
          onclick="showInfoPanel('protection','${shop.name} ‚Äî Protection')"
        >‚Ñπ</button>
      </div>

      ${
        shop.protection < maxLevel
        ? `<button onclick="upgradeProtection(${i})">Upgrade Protection (¬£${protectionCost})</button>`
        : "<div class='small'>Max Level</div>"
      }

      <div class="row" style="margin-top:10px;">
        <div class="small">
          Store Management: Level ${shop.management}<br>
          ${managementText}
        </div>
        <button class="infoBtn"
          onmouseenter="showTooltip(event,'management')"
          onmousemove="moveTooltip(event)"
          onmouseleave="hideTooltip()"
          onclick="showInfoPanel('management','${shop.name} ‚Äî Management')"
        >‚Ñπ</button>
      </div>

      ${
        shop.management < maxLevel
        ? `<button onclick="upgradeManagement(${i})">Upgrade Management (¬£${managementCost})</button>`
        : "<div class='small'>Max Level</div>"
      }

      <div class="small" style="margin-top:6px;">
        Staff Cost During Wave: ¬£${(shop.salary || 0).toFixed(1)} / sec
      </div>
    `;

    container.appendChild(div);
  });
}

function buildCCTVUI(){
  const panel = document.getElementById("cctvPanel");
  const text = cctvLevels[cctvLevel];
  const cost = cctvLevel < maxLevel ?
    upgradeCost(120, cctvLevel) : null;

  panel.innerHTML = `
    <div class="small">
      CCTV Level ${cctvLevel}<br>
      ${text}
    </div>
    ${cctvLevel < maxLevel ?
      `<button onclick="upgradeCCTV()">Upgrade CCTV (¬£${cost})</button>`
      : "<div class='small'>Max Level</div>"}
  `;
}

/* ======================
   UPGRADES
====================== */
function upgradeProtection(i){
  if(gamePhase !== "planning") return;
  const shop = shops[i];
  if(shop.protection >= maxLevel) return;

  const cost = upgradeCost(100, shop.protection);
  if(money < cost) return;

  money -= cost;
  shop.protection++;

  if(shop.protection === 3) shop.salary += 0.5;
  if(shop.protection === 4) shop.salary += 0.8;

  buildShopUI();
}

function upgradeManagement(i){
  if(gamePhase !== "planning") return;
  const shop = shops[i];
  if(shop.management >= maxLevel) return;

  const cost = upgradeCost(80, shop.management);
  if(money < cost) return;

  money -= cost;
  shop.management++;

  if(shop.management === 3) shop.salary += 0.4;
  if(shop.management === 4) shop.salary += 0.6;

  buildShopUI();
}

function upgradeCCTV(){
  if(gamePhase !== "planning") return;
  if(cctvLevel >= maxLevel) return;

  const cost = upgradeCost(120, cctvLevel);
  if(money < cost) return;

  money -= cost;
  cctvLevel++;
  buildCCTVUI();
}

/* ======================
   PHASE CONTROL
====================== */
function startWave(){
  if(gamePhase !== "planning") return;

  waveStats = {
    mallRevenue: 0,
    theftLoss: 0,
    thefts: 0,
    offenders: new Set(),
    salaryPaid: 0
  };

  gamePhase = "wave";
  waveTimer = waveLength;

  // default view to Wave Overview when wave starts
  setRightMode("wave");
}

function endWave(){
  gamePhase = "planning";
  waveNumber++;
  document.getElementById("waveNum").innerText = waveNumber;
  visitors = [];
}

/* ======================
   GUARDS
====================== */
canvas.addEventListener("click", function(e){
  if(!placingGuard || gamePhase !== "planning") return;

  const rect = canvas.getBoundingClientRect();
  guards.push({
    x: e.clientX - rect.left,
    y: e.clientY - rect.top,
    radius:130
  });

  money -= 150;
  placingGuard = false;
});

function addGuard(){
  if(gamePhase !== "planning") return;
  if(money < 150) return;
  placingGuard = true;
}

/* ======================
   VISITOR LOGIC
====================== */
function spawnVisitor(){
  let type;
  const r = Math.random();

  if(waveNumber === 1){
    type = r < 0.60 ? "ordinary"
         : r < 0.90 ? "opportunist"
         : "determined";
  }
  else if(waveNumber === 2){
    type = r < 0.55 ? "ordinary"
         : r < 0.85 ? "opportunist"
         : "determined";
  }
  else{
    type = r < 0.45 ? "ordinary"
         : r < 0.75 ? "opportunist"
         : "determined";
  }

  const profiles = {
    ordinary:{ M:10, S:40, risk:1.5, effort:1.2, maxThefts:1 },
    opportunist:{ M:25, S:25, risk:1.0, effort:1.0, maxThefts:2 },
    determined:{ M:40, S:10, risk:0.5, effort:1.5, maxThefts: (waveNumber === 1 ? 2 : 4) }
  };

  const p = profiles[type];

  visitors.push({
    x:200,
    y:200,
    pathIndex:0,
    speed:60,
    type:type,

    baseS:p.S,
    M:p.M,
    S:p.S,
    O:20,
    R:0,

    riskSensitivity:p.risk,
    effortSensitivity:p.effort,

    theftsCommitted:0,
    maxThefts:p.maxThefts,

    visitedShops:{},
    finished:false
  });
}

/* ======================
   UPDATE
====================== */
function update(dt){
  if(gamePhase === "wave"){
    waveTimer -= dt;

    if(waveTimer > waveLength * 0.4){
      if(Math.random() < 0.04) spawnVisitor();
    }

    visitors.forEach(v=>{
      moveVisitor(v,dt);
      applySecurity(v);
      checkShops(v);
    });

    const salaryThisFrame = getTotalSalaryPerSec() * dt;
    money -= salaryThisFrame;
    waveStats.salaryPaid = (waveStats.salaryPaid || 0) + salaryThisFrame;

    visitors = visitors.filter(v => !v.finished);

    if(waveTimer <= 0 && visitors.length === 0){
      endWave();
    }
  }
}

function moveVisitor(v, dt){
  if(v.finished) return;

  const targetIndex = v.pathIndex + 1;
  if(targetIndex >= path.length){
    v.finished = true;
    return;
  }

  const next = path[targetIndex];
  const dx = next.x - v.x;
  const dy = next.y - v.y;
  const dist = Math.hypot(dx, dy);

  const step = v.speed * dt;

  if(dist <= step){
    v.x = next.x;
    v.y = next.y;
    v.pathIndex++;
  } else {
    v.x += dx / dist * step;
    v.y += dy / dist * step;
  }
}

function applySecurity(v){
  v.R = cctvLevel * 5;
  v.S = v.baseS;

  guards.forEach(g=>{
    if(Math.hypot(v.x-g.x,v.y-g.y) < g.radius){
      v.R += 15;
      v.S -= 5;
    }
  });

  v.S = Math.max(0, v.S);
}

function checkShops(v){
  shops.forEach((shop, index)=>{
    if(v.visitedShops[index]) return;

    if(Math.hypot(v.x - shop.x, v.y - shop.y) < 60){
      v.visitedShops[index] = true;

      v.O = shop.baseOpportunity - shop.protection * 5 * v.effortSensitivity;
      v.M -= shop.management * 2;

      const theftScore = v.M + v.O - (v.R * v.riskSensitivity);

      if(v.theftsCommitted < v.maxThefts && theftScore > 30){
        const theftLoss = shop.value * 0.75;

        money -= theftLoss;
        reputation -= 2;

        waveStats.theftLoss += theftLoss;
        waveStats.thefts++;
        waveStats.offenders.add(v);

        v.theftsCommitted++;
      }
      else if(v.S > v.M){
        const mallShare = shop.value * 0.30;

        money += mallShare;
        reputation += 1;

        waveStats.mallRevenue += mallShare;
      }
    }
  });
}

/* ======================
   DRAW
====================== */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.strokeStyle="#444";
  ctx.lineWidth=40;
  ctx.beginPath();
  ctx.moveTo(path[0].x, path[0].y);
  for(let i = 1; i < path.length; i++){
    ctx.lineTo(path[i].x, path[i].y);
  }
  ctx.stroke();

  shops.forEach(shop=>{
    ctx.fillStyle="#333";
    ctx.fillRect(shop.x-50,shop.y-30,100,60);
    ctx.fillStyle="#fff";
    ctx.fillText(shop.name,shop.x-40,shop.y);
  });

  guards.forEach(g=>{
    ctx.strokeStyle="rgba(0,200,255,0.3)";
    ctx.beginPath();
    ctx.arc(g.x,g.y,g.radius,0,Math.PI*2);
    ctx.stroke();
    ctx.fillStyle="#0ff";
    ctx.fillRect(g.x-6,g.y-6,12,12);
  });

  visitors.forEach(v=>{
    ctx.fillStyle=v.type==="ordinary"?"#0f0"
               : v.type==="opportunist"?"#ff0":"#f00";
    ctx.beginPath();
    ctx.arc(v.x,v.y,8,0,Math.PI*2);
    ctx.fill();
  });

  document.getElementById("money").innerText = Math.round(money);
  document.getElementById("rep").innerText = Math.round(reputation);
  document.getElementById("visitors").innerText = visitors.length;
  document.getElementById("phaseDisplay").innerText =
    gamePhase === "planning" ? "Planning" : "Wave Active";

  const totalSalary = (gamePhase === "wave") ? getTotalSalaryPerSec() : 0;
  document.getElementById("salaryDisplay").innerText =
    totalSalary.toFixed(1) + "/sec";

  // Right panel: wave view updates live (only if wave tab selected or wave mode visible)
  if(gamePhase === "wave"){
    const net = waveStats.mallRevenue - waveStats.theftLoss - waveStats.salaryPaid;

    let netColor = "#aaa";
    if(net > 0) netColor = "#4caf50";
    else if(net < 0) netColor = "#e53935";

    document.getElementById("analyticsPanel").innerHTML = `
      <b>Revenue</b><br>
      Mall Revenue: ¬£${waveStats.mallRevenue.toFixed(0)}<br><br>

      <b>Costs</b><br>
      Salary: ¬£${waveStats.salaryPaid.toFixed(0)}<br>
      Theft Loss: ¬£${waveStats.theftLoss.toFixed(0)}<br><br>

      <b>Crime</b><br>
      Thefts: ${waveStats.thefts}<br>
      Offenders: ${waveStats.offenders.size}<br><br>

      <div style="font-size:16px; color:${netColor}">
        Net: ¬£${net.toFixed(0)}
      </div>
    `;
  } else {
    document.getElementById("analyticsPanel").innerHTML = "Start a wave to see results.";
  }
}

/* ======================
   GAME LOOP
====================== */
let last=0;
function loop(t){
  const dt=(t-last)/1000;
  last=t;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

// Build UI and start
buildShopUI();
buildCCTVUI();
setRightMode("wave");
loop(0);
</script>
</body>
</html>
